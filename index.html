<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Private Digital Asset (Iran)</title>

  <!-- Tailwind for layout only -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest/dist/lucide.min.js"></script>

  <style>
    /* -------------------------
       Theme: Quiet Institutional Dark Mode + Soft UI (neumorphism)
       - Subtle inner/outer shadows, soft radiuses, smooth transitions
       ------------------------- */
    :root{
      --bg: #232323;         /* background */
      --panel: #282828;      /* panel surface (slightly lifted) */
      --text: #DADADA;       /* primary body text */
      --muted: #BFBFBF;      /* secondary text / muted */
      --divider: rgba(255,255,255,0.03);    /* soft separators */
      --accent: #43A047;     /* muted green accent */
      --accent-dark: #3d923f;/* darker accent */
      --soft-shadow-dark: rgba(0,0,0,0.65);
      --soft-shadow-light: rgba(255,255,255,0.02);
      --soft-elev: 10px 10px 24px rgba(0,0,0,0.55);
      --soft-elev-sm: 6px 6px 18px rgba(0,0,0,0.48);
      --transition: 220ms cubic-bezier(.2,.9,.2,1);
    }

    html,body,#app{height:100%}
    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      margin:0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Soft UI panels */
    .panel {
      background: var(--panel);
      border-radius: 14px;
      border: 1px solid var(--divider);
      box-shadow:
        8px 8px 20px var(--soft-shadow-dark),
        -6px -6px 16px var(--soft-shadow-light),
        inset 0 1px 0 rgba(255,255,255,0.02);
      transition: box-shadow var(--transition), transform var(--transition);
    }
    .panel:active { transform: translateY(1px); }

    /* Buttons: soft */
    .soft-btn, button {
      border-radius: 10px;
      padding: 8px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
      border: 1px solid rgba(255,255,255,0.02);
      box-shadow:
        4px 6px 14px rgba(0,0,0,0.45),
        inset 0 1px 0 rgba(255,255,255,0.02);
      color: var(--text);
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition), opacity var(--transition);
      font-size: 13px;
    }
    .soft-btn:hover { transform: translateY(-2px); opacity:0.98; }
    /* Accent buttons keep brand color but soft */
    .accent-btn {
      background: var(--accent);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow:
        0 6px 18px rgba(0,0,0,0.45),
        inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .accent-btn:hover { filter:brightness(1.02); transform: translateY(-2px); }

    /* Avatar fallback - soft */
    .avatar-fallback {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
      display:flex; align-items:center; justify-content:center;
      color:var(--text); font-weight:600; text-transform:uppercase;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02), 4px 6px 12px rgba(0,0,0,0.48);
    }

    /* Avatar wrapper + online dot */
    .avatar-wrap { position: relative; width:40px; height:40px; flex-shrink:0; display:inline-block; border-radius:12px; overflow:hidden; }
    .avatar-wrap img, .avatar-wrap .avatar-fallback { width:40px; height:40px; border-radius:10px; object-fit:cover; display:block; }
    .online-dot {
      position: absolute;
      right: -2px;
      bottom: -2px;
      width:14px;
      height:14px;
      border-radius:9999px;
      background: var(--accent);
      border: 3px solid var(--panel);
      box-shadow: 0 6px 18px rgba(67,160,71,0.14);
      transform-origin: 50% 50%;
      animation: blinkPulse 1.6s infinite ease-in-out;
    }

    /* STATUS small animations */
    @keyframes blinkPulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.45; transform: scale(1.08); }
      100% { opacity: 1; transform: scale(1); }
    }
    .online-svg { width: 14px; height: 14px; color: var(--accent); animation: blinkPulse 1.6s infinite ease-in-out; }

    .status-number { animation: numberPulse 2200ms infinite ease-in-out; color: var(--accent-dark); font-weight:700; }
    @keyframes numberPulse { 0% { transform: translateY(0); } 50% { transform: translateY(-1px) scale(1.02); } 100% { transform: translateY(0); } }

    /* Messages - slightly softened cards */
    .msg-admin { background: rgba(255,255,255,0.01); border-left:4px solid rgba(74,144,226,0.06); padding:12px; border-radius:12px; box-shadow: 4px 6px 18px rgba(0,0,0,0.45); }
    .msg-regular { background: rgba(255,255,255,0.01); padding:12px; border-radius:12px; box-shadow: 4px 6px 18px rgba(0,0,0,0.45); }
    .msg-system { font-style: italic; color: #9CA3AF; padding: 8px; }

    .highlight-new { animation: newJoinHighlight 2000ms ease-in-out forwards; border-radius: 12px; }
    @keyframes newJoinHighlight {
      0% { box-shadow: 0 0 0 rgba(67,160,71,0); transform: scale(1); background-color: transparent; }
      12% { background-color: rgba(67,160,71,0.03); transform: scale(1.006); }
      60% { box-shadow: 0 20px 40px rgba(67,160,71,0.07); transform: scale(1.01); }
      100% { box-shadow: 0 0 0 rgba(67,160,71,0); transform: scale(1); background-color: transparent; }
    }

    /* subtle admin badge */
    .admin-badge {
      display:inline-block;
      font-size:11px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.03);
      padding:2px 6px;
      border-radius:999px;
      margin-left:8px;
      line-height:1;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
    }

    /* Header layout & logo tweaks with soft feel */
    .header-row { display:flex; align-items:center; justify-content:space-between; gap:16px; width:100%; }
    .left-meta { display:flex; flex-direction:column; gap:6px; flex:1; min-width:0; }
    .right-meta { display:flex; align-items:center; gap:12px; justify-content:flex-end; flex-shrink:0; }

    .header-logo-wrap { display:inline-flex; align-items:center; justify-content:center; flex-shrink:0; align-self:flex-start; margin-left:12px; }
    .header-logo {
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.03);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04));
      width:56px; height:56px;
      box-shadow: 8px 10px 28px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.02);
      object-fit:cover;
    }
    .header-logo-fallback {
      width:56px; height:56px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:14px; background:#1b1b1b; color:#fff; font-weight:700; font-size:14px;
      border:1px solid rgba(255,255,255,0.02);
      box-shadow: 8px 10px 28px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.02);
    }

    /* Online indicator */
    .online-indicator { width: 16px; height:16px; display:inline-block; position:relative; flex-shrink:0; margin-right:6px; }
    .online-indicator .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); box-shadow: 0 6px 16px rgba(67,160,71,0.16); position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
    .online-indicator .ring { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:14px; height:14px; border-radius:50%; border:1px solid rgba(67,160,71,0.12); box-sizing:border-box; animation: onlinePulse 1600ms infinite ease-in-out; }
    @keyframes onlinePulse { 0% { transform: translate(-50%,-50%) scale(1); opacity:1; } 50% { transform: translate(-50%,-50%) scale(1.12); opacity:0.45; } 100% { transform: translate(-50%,-50%) scale(1); opacity:1; } }

    /* Stat boxes with soft depth */
    .meta-stats { display:flex; gap:12px; align-items:center; }
    .stat-box {
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:12px;
      border: 1px solid rgba(255,255,255,0.02);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));
      min-width:120px;
      box-shadow: var(--soft-elev-sm);
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .stat-box:hover { transform: translateY(-3px); box-shadow: var(--soft-elev); }
    .stat-icon { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; flex-shrink:0; border-radius:8px; background:rgba(0,0,0,0.04); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
    .stat-text { display:flex; flex-direction:column; line-height:1; text-align:left; }
    .stat-text .muted { font-size:12px; color:var(--muted); }
    .stat-text .count { font-weight:700; color:var(--text); font-size:15px; }

    .users-badge {
      width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04));
      border: 1px solid rgba(255,255,255,0.02);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02), 6px 8px 18px rgba(0,0,0,0.45);
      flex-shrink:0;
    }

    /* Textareas and inputs: soft inner shadow */
    textarea, input[type="text"], input[type="search"] {
      background: var(--panel);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.02);
      padding: 10px;
      box-shadow: inset 4px 6px 16px rgba(0,0,0,0.55), inset -2px -2px 8px rgba(255,255,255,0.01);
      color: var(--text);
      transition: box-shadow var(--transition), transform var(--transition);
      resize: vertical;
    }
    textarea:focus, input:focus { outline: none; box-shadow: 0 14px 40px rgba(0,0,0,0.6); transform: translateY(-1px); }

    /* subtle link hover */
    a { color: inherit; text-decoration: none; }
    a:hover { text-decoration: none; opacity:0.95; }

    /* responsiveness */
    @media (max-width:900px){
      .header-logo { width:48px; height:48px; }
      .header-logo-fallback { width:48px; height:48px; font-size:13px; }
      .users-badge { width:30px; height:30px; }
      .stat-box { padding:8px 10px; min-width:100px; }
    }
    @media (max-width:640px){
      .header-logo { width:44px; height:44px; }
      .header-logo-fallback { width:44px; height:44px; font-size:12px; }
      .right-meta { gap:10px; }
      .meta-stats { gap:8px; }
    }
    @media (max-width:420px){
      .header-row { flex-direction:column; align-items:stretch; gap:10px; }
      .right-meta { justify-content:space-between; }
      .meta-stats { width:100%; justify-content:space-between; }
      .header-logo-wrap { align-self:flex-end; margin-left:0; }
    }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen p-4 md:p-8">
    <header class="mb-4" role="banner">
      <div class="header-row">
        <!-- LEFT: title + meta -->
        <div class="left-meta">
          <h1 id="group-title" class="text-xl md:text-2xl font-semibold" style="color:var(--text); margin:0">Private Digital Asset (Iran)</h1>
          <div class="text-sm" style="color:var(--muted);">
            <!-- updated period to 8 January 2026 — 15 May 2026 -->
            <span id="date-range">Period: 8 January 2026 — 15 May 2026</span>
          </div>
        </div>

        <!-- RIGHT: members + status -->
        <div class="right-meta" aria-hidden="false">
          <div class="meta-stats" role="group" aria-label="Group quick stats">
            <!-- MEMBERS: users icon (lucide) + count; users icon placed inside a small users-badge for realism -->
            <div class="stat-box" id="members-box" aria-hidden="false">
              <div class="users-badge stat-icon" aria-hidden="true">
                <i data-lucide="users" aria-hidden="true"></i>
              </div>
              <div class="stat-text" style="min-width:70px;">
                <div class="muted">Members</div>
                <div id="header-member-count" class="count">~140</div>
              </div>
            </div>

            <!-- STATUS block (kept behavior & ids intact) -->
            <div class="stat-box" id="status-box" aria-hidden="false" style="min-width:150px; justify-content:flex-end;">
              <div style="display:flex; align-items:center; gap:10px;">
                <div class="online-indicator" aria-hidden="true" title="Online">
                  <div class="ring"></div>
                  <div class="dot"></div>
                </div>
                <div style="text-align:left;">
                  <div class="muted" style="font-size:12px;">Status</div>
                  <div id="status-text" class="text-sm" style="color:var(--text); font-weight:600;">Active now: <span id="status-number" class="status-number">6</span></div>
                </div>
              </div>
            </div>
          </div>

          <!-- SITE LOGO placed to the far right as requested; has onerror fallback -->
          <a href="/" class="header-logo-wrap" aria-label="Private Digital Asset logo" title="Private Digital Asset">
            <img
              id="site-logo"
              src="assets/logo.png"
              alt="Private Digital Asset logo"
              width="56" height="56"
              decoding="async"
              loading="eager"
              class="header-logo"
              onerror="(function(el){ el.style.display='none'; try{ var f = document.createElement('div'); f.className='header-logo-fallback'; f.textContent='PDA'; el.parentNode && el.parentNode.appendChild(f);}catch(e){} })(this);"
            />
          </a>
        </div>
      </div>
    </header>

    <main class="flex flex-1 flex-col md:flex-row gap-4">
      <section class="flex-1 flex flex-col panel overflow-hidden">
        <div class="p-4 border-b" style="border-color:var(--divider); display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="text-sm font-medium" style="color:var(--text)">PINNED CONTENT (always visible)</div>
            <ul id="pinned-list" class="mt-2 text-sm" style="color:var(--muted); list-style:none; padding-left:0; gap:6px;"></ul>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
            <button id="copy-pinned" class="soft-btn" style="background:transparent; border-color:var(--divider); color:var(--text); font-size:12px;">Copy</button>
            <button id="toggle-notes" class="soft-btn" style="background:transparent; border-color:var(--divider); color:var(--text); font-size:12px;" aria-expanded="false">Notes</button>
          </div>
        </div>

        <div id="chat-window" class="p-4 flex-1 overflow-auto" role="log" aria-live="polite">
          <div id="messages-list" class="space-y-3"></div>
        </div>

        <div class="p-4 border-t" style="border-color:var(--divider); background:transparent;">
          <div id="composer-locked" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <div style="color:var(--muted)">Posting is locked until verification. Please request verification to post.</div>
            <div>
              <button id="verify-btn" class="accent-btn" style="padding:8px 10px; border-radius:10px;">Request verification</button>
            </div>
          </div>

          <div id="composer" class="hidden" style="display:flex; gap:12px; margin-top:8px; align-items:flex-start;">
            <textarea id="composer-text" placeholder="Type a message — Enter to send" class="flex-1" style="padding:12px; border-radius:12px; border:1px solid var(--divider); background:var(--panel); color:var(--text); min-height:64px;"></textarea>
            <div>
              <button id="send-btn" class="accent-btn" style="padding:8px 12px; border-radius:10px;">Send</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="w-full md:w-72 flex-shrink-0 panel p-4">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
          <h2 style="font-weight:600; color:var(--text); font-size:14px;">MEMBERS (names)</h2>
          <span style="color:var(--muted); font-size:12px;">Realistic view</span>
        </div>

        <!-- Admin card pinned to top -->
        <div id="admin-card" class="admin-card" style="display:none;">
          <div class="admin-title">ADMINS</div>
          <div id="admin-list" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>

        <div id="members-list" style="display:flex; flex-direction:column; gap:10px; color:var(--muted);"></div>
      </aside>
    </main>

    <div id="behavior-notes" class="panel" style="display:none; margin-top:16px; padding:12px; color:var(--muted);">
      <h3 style="color:var(--text); font-weight:600;">REALISTIC CHAT PARTICIPATION (pattern & stats)</h3>
      <pre style="white-space:pre-wrap; color:var(--muted)">(Overview & instructor notes stored in the script)</pre>
    </div>

    
  </div>

  <script>
    /************************************************************************
     * Full script preserved.
     * I did NOT remove or alter your logic or seeded data.
     * Visual-only changes were applied (soft UI). JS/arrays/functions are untouched.
     * Date/display updated to 8 January 2026 — 15 May 2026.
     ************************************************************************/

    /* ---------------------------
       Pinned content
       --------------------------- */
    const pinned = [
      "Privacy rules (Iran-focused)",
      "Verification required to participate in sensitive discussions",
      "Group purpose: protect asset value, not investment advice",
      "No screenshots or forwarding",
      "Sensitive questions → DM the admin"
    ];

    /* ---------------------------
       Members (140) - unchanged names list
       --------------------------- */
    const members = [
      "Ariamen Niknam","Zhinos Farmani","Misaq Dashti","Pardis Sohrabi","Pouyan Tarabnia","Zhaleh Pourbakhtiar","Derina Kermani","Sohrab Mehrayin","Sepand Yaghmaei","Bakhtiar Kohandel",
      "Taraneh Rozbehani","Saman Tihu","Padideh Naderi","Niko Foroughi","Hamoon Zagros","Naysabeh Tahmasbi","Diana Siavoshi","Bahman Azarpi","Negin Koneshlu","Rosta Mehrayin",
      "Saman-yar Ahoui","Yara Zhilavand","Parsa Shayeg","Mahraz Golestani","Siamak Hoorami","Helia Mahinpour","Nima Taban","Parvosh Ramyar","Hooshang Bahari","Naghmeh Soroush",
      "Kourosh Nikmanesh","Kian Rudbar","Narges Delaram","Sudeh Kianpour","Amin Shayegan","Niloufar Behrbakhsh","Soha Armaghani","Dara Firoozi","Zhila Mehraban","Samyar Rudgar",
      "Mahrokh Khodadadi","Nava Sayad","Parmida Sahli","Parham Soleimani-Nejad","Sepideh Nikandish","Pegah Derakhshan","Toranj Keyvani","Shahin Pejmanfar","Sheyda Alavi","Hoshmand Kateb",
      "Mojgan Forouhar","Ahura Bahrami","Azadeh Nistani","Farshid Yousefi","Yeganeh Semnani","Siros Padidar","Ainaz Goodarzi","Mani Arashid","Roonak Ghaffari","Radin Sepehri",
      "Mahshad Barghaei","Keyvan Rostami","Nazanin Dehghani","Homa Nadali","Nira Eghbali","Pouyan Kohanzad","Matiah Khoramdel","Baran Jamshidi","Kiarash Mardani","Zaria Farhang",
      "Dihim Nazari","Behnam Alghasi","Golareh Malkani","Koroshian Tarkan","Raha Beheshti","Soheil Nikkhah","Zhaki Zhalehpoor","Rambod Hejri","Shaparak Fallahi","Kamyar Homayounfar",
      "Tarlan Daryabigi","Kimia Khojasteh","Pouya Nasrollahi","Mahyar Farahani","Ladan Soleimani","Niusha Mehraban","Sina Khaleghi","Golsa Shayegan","Abtin Kamali","Farnaz Bahrampour",
      "Mehrangiz Rabiei","Arshan Mahdavi","Yasaman Azarban","Shervin Ganji","Tarnam Mahasti","Arshin Boroumand","Nikzad Shahidi","Bahareh Sirafi","Kikavous Niknami","Mehrnoush Azargun",
      "Parsa Delshad","Zhubin Razaqi","Tahmineh Nikkhah","Houtan Delpak","Roya Danaei","Niloufar Shahryar","Zhyar Kamyab","Mina Salimi","Shayan Mazinani","Diana Farahmand",
      "Arian Mehranfar","Yekta Feyzi","Naderah Pasandideh","Kianoush Damghani","Azadeh Mehrgostar","Samdel Shahrokhi","Mahtab Forouzh","Shayan Nikpour","Koraogh Lilizad","Hamasin Kouhi",
      "Pouyan Zanganeh","Ramin Yarmohammadi","Niloufar Arshidi","Gerard Golchin","Hooman Panjabi","Rana Keyvani","Shahrooz Mehrabi","Minoudokht Bahrami","Adrian Feyzabad","Zarrin Golmohammadi",
      "Farshad Kamkar","Pegah Naderian","Arzu Farozand","Delara Niri","Niko Golrokh","Sepehr Nikrosh","Samaneh Arvand","Yousef Rouzbeh","Mahtab Nobahar","Pedram Shakiba"
    ];

    /* ---------------------------
       Seeded messages (exactly as provided, dates updated to match timeframe)
       --------------------------- */
    const seededMessages = [
      { time: "08:57", member: "System", text: "You joined the group.", role: "system" },
      { time: "08:59", member: "System", text: "Online: Tehran, Isfahan, Shiraz, Mashhad (4 people online)", role: "system" },
      { time: "09:02", member: "admin (Naghmeh Soroush)", text: "Welcome. Please read the pinned rules.", role: "admin" },
      { time: "09:11", member: "moderator A (Hooshang Bahari)", text: "For sensitive issues, verification is required. DM the admin.", role: "mod" },
      { time: "09:18", member: "Member (Tehran) — Amin Shayegan", text: "I read the rules.", role: "member" },
      { time: "09:28", member: "System", text: "(Seen) a few members are browsing the pinned items.", role: "system" },
      { time: "09:41", member: "Member (Isfahan) — Sudeh Kianpour", text: "Bank transfers were delayed today.", role: "member" },
      { time: "09:44", member: "moderator B (Parvosh Ramyar)", text: "Please take banking questions to the admin privately.", role: "mod" },
      { time: "10:01", member: "Member (Tehran) — Amin Shayegan", text: "Understood.", role: "member" },
      { time: "12:10", member: "System", text: "Pause — members are reading pinned rules.", role: "system" },
      { time: "15:08", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "Morning traffic in Tehran was bad.", role: "member" },
      { time: "15:10", member: "Member (Karaj) — Narges Delaram", text: "I saw the same problem.", role: "member" },
      { time: "16:55", member: "System", text: "Pause — new members are quietly browsing.", role: "system" },
      { time: "17:30", member: "System", text: "New member Rosta Mehrayin is viewing the group.", role: "system" },
      { time: "19:12", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "It seems the rial is weaker today.", role: "member" },
      { time: "19:50", member: "admin (Naghmeh Soroush)", text: "Remember to DM for sensitive matters.", role: "admin" },
      { time: "20:05", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "Just my experience — USDT helped me last week.", role: "member" },
      { time: "21:00", member: "System", text: "Quiet — most members are offline.", role: "system" },

      { time: "08:50", member: "Member (Tehran) — Amin Shayegan", text: "I joined yesterday. Still not verified.", role: "member" },
      { time: "09:15", member: "System", text: "(Scrolling) New member reads some messages from last week.", role: "system" },
      { time: "11:00", member: "admin (Naghmeh Soroush)", text: "The verification queue is nearly full today. Next review window is tomorrow.", role: "admin" },
      { time: "13:15", member: "Member (Isfahan) — Sudeh Kianpour", text: "I was verified yesterday.", role: "member" },
      { time: "13:16", member: "moderator A (Hooshang Bahari)", text: "Welcome — please DM for questions.", role: "mod" },
      { time: "14:12", member: "Member (Karaj) — Kian Rudbar", text: "I’m waiting for verification.", role: "member" },
      { time: "15:00", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "A few who got verified said USDT helped.", role: "member" },
      { time: "16:40", member: "moderator B (Parvosh Ramyar)", text: "Please be patient. Admin reviews in batches.", role: "mod" },
      { time: "18:05", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "USDT helped me avoid the previous drop.", role: "member" },
      { time: "18:12", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "Me too. Holding some USDT helped.", role: "member" },
      { time: "19:30", member: "System", text: "Relative silence — members mostly reading.", role: "system" },
      { time: "21:12", member: "Member (Karaj) — Kian Rudbar", text: "Still waiting.", role: "member" },

      { time: "18 Jan", member: "Member", text: "Inflation is high. Saving is hard.", role: "member" },
      { time: "25 Jan", member: "moderator A", text: "Reminder — sensitive questions → DM admin.", role: "mod" },
      { time: "30 Jan", member: "Member", text: "Tehran traffic was heavy this week.", role: "member" },
      { time: "08 Jan", member: "admin", text: "Verification process updated. No action required now.", role: "admin" },

      { time: "09:31", member: "Member (Karaj) — Narges Delaram", text: "I got verified. Verification step complete.", role: "member" },
      { time: "09:34", member: "Member (Tehran) — Amin Shayegan", text: "Me too.", role: "member" },
      { time: "10:00", member: "Member (Isfahan) — Sudeh Kianpour", text: "Happy for you.", role: "member" },
      { time: "14:06", member: "admin (Naghmeh Soroush)", text: "Verification window is limited today. Please wait your turn.", role: "admin" },
      { time: "16:21", member: "New member (Isfahan) — Rosta Mehrayin", text: "Any tips to start?", role: "new" },
      { time: "16:24", member: "moderator A (Hooshang Bahari)", text: "Please DM admin for details.", role: "mod" },
      { time: "18:02", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "Bank delays continue.", role: "member" },

      { time: "08:45", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "Commute was easier today.", role: "member" },
      { time: "09:00", member: "Member (Tehran) — Amin Shayegan", text: "Glad.", role: "member" },
      { time: "10:15", member: "Member (Tehran) — Amin Shayegan", text: "Still waiting for verification.", role: "member" },
      { time: "13:30", member: "moderator B (Parvosh Ramyar)", text: "Reminder: no screenshots or forwarding.", role: "mod" },
      { time: "15:00", member: "Member (Karaj) — Narges Delaram", text: "The verification took a while but arrived.", role: "member" },
      { time: "17:05", member: "Member (Karaj) — Narges Delaram", text: "Rial was slightly more stable today.", role: "member" },

      { time: "09:10", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "I was verified yesterday.", role: "member" },
      { time: "12:55", member: "Member (Tehran) — Amin Shayegan", text: "Morning traffic and rial volatility — nothing new.", role: "member" },
      { time: "15:02", member: "moderator A (Hooshang Bahari)", text: "Sensitive questions → DM admin.", role: "mod" },
      { time: "16:32", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "Just FYI, I had some USDT.", role: "member" },
      { time: "16:35", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "My experience was similar, just saying.", role: "member" },

      { time: "08:32", member: "Member (Karaj) — Kian Rudbar", text: "Have you seen the bank notice today?", role: "member" },
      { time: "09:10", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "I was verified yesterday.", role: "member" },
      { time: "12:55", member: "Member (Tehran) — Amin Shayegan", text: "No change; delays continue.", role: "member" },
      { time: "14:55", member: "moderator B (Parvosh Ramyar)", text: "Verification is processed in batches; please be patient.", role: "mod" },
      { time: "15:10", member: "New member — Rosta Mehrayin", text: "Thanks. I will wait.", role: "new" },
      { time: "17:10", member: "Member (Tehran) — Amin Shayegan", text: "Personal view: USDT still looks safer.", role: "member" },

      { time: "08:50", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "It’s warmer here this morning.", role: "member" },
      { time: "09:20", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "Still waiting for admin verification.", role: "member" },
      { time: "10:00", member: "Member (Isfahan) — Sudeh Kianpour", text: "I was verified; everything is normal.", role: "member" },
      { time: "13:40", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "No news. Testing my patience.", role: "member" },
      { time: "14:00", member: "moderator A (Hooshang Bahari)", text: "Please do not post personal contact info publicly.", role: "mod" },
      { time: "15:29", member: "Member (Isfahan) — Sudeh Kianpour", text: "I got verified a few days ago. Nothing special.", role: "member" },
      { time: "17:05", member: "Member (Karaj) — Narges Delaram", text: "Personal experience: USDT helped preserve value.", role: "member" },
      { time: "19:10", member: "System", text: "admin offline — no public post.", role: "system" },

      { time: "09:05", member: "System", text: "3–6 people were online in the morning.", role: "system" },
      { time: "10:12", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "Tehran is warmer than last week.", role: "member" },
      { time: "11:00", member: "admin (Naghmeh Soroush)", text: "Verification queue updated; if you applied in the past 72 hours, check your DM.", role: "admin" },
      { time: "13:40", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "Still waiting. My patience is being tested.", role: "member" },
      { time: "14:30", member: "moderator B (Parvosh Ramyar)", text: "Reminder: privacy is important. No screenshots or forwarding.", role: "mod" },
      { time: "17:02", member: "moderator A (Hooshang Bahari)", text: "Please DM sensitive banking questions.", role: "mod" },
      { time: "18:30", member: "Member (Karaj) — Narges Delaram", text: "A few people got verified, no big news. Calm.", role: "member" },
      { time: "20:05", member: "Member (Karaj) — Narges Delaram", text: "My USDT mention is personal experience. Not advice.", role: "member" }
    ];

    /* ---------------------------
       Avatar heuristics & helpers
       --------------------------- */
    const femaleTokens = [
      "zhaleh","derina","taraneh","padideh","niko","naysabeh","diana","negin","yara","narges",
      "sudeh","niloufar","pegah","shaparak","mina","roonak","zaria","mojgan","azadeh","yasaman",
      "delara","bahareh","mehrnoush","zarrin","mahtab","niusha","golsa","yekta","nazanin","homa",
      "farah","parida","parisa","soheila","zahra","fatemeh","marjan","sara","roxana","rosta"
    ];
    function looksFemale(name){ if(!name) return false; const lower=name.toLowerCase(); return femaleTokens.some(t=>lower.includes(t)); }
    function randInt(max){ return Math.floor(Math.random()*max); }

    // memberProfiles now include gender and online props; isAdmin set later
    let memberProfiles = members.map(name => ({ name, avatar: null, gender: looksFemale(name) ? 'female' : 'male', online: false, isAdmin: false }));

    /* ---------------------------
       localStorage helpers for avatar persistence and online list
       --------------------------- */
    const AVATAR_MAP_KEY = 'group_avatar_map_v1';
    const ONLINE_LIST_KEY = 'group_online_list_v1';

    function loadAvatarMap(){
      try { const raw = localStorage.getItem(AVATAR_MAP_KEY); return raw ? JSON.parse(raw) : {}; } catch(e){ return {}; }
    }
    function saveAvatarMap(map){
      try { localStorage.setItem(AVATAR_MAP_KEY, JSON.stringify(map)); } catch(e){}
    }

    function loadOnlineList(){
      try { const raw = localStorage.getItem(ONLINE_LIST_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }
    function saveOnlineList(list){
      try { localStorage.setItem(ONLINE_LIST_KEY, JSON.stringify(list)); } catch(e){}
    }

    /* ---------------------------
       DOM refs
       --------------------------- */
    const pinnedList = document.getElementById('pinned-list');
    const membersListEl = document.getElementById('members-list');
    const adminCardEl = document.getElementById('admin-card');
    const adminListEl = document.getElementById('admin-list');
    const messagesList = document.getElementById('messages-list');
    const chatWindow = document.getElementById('chat-window');
    const statusNumberEl = document.getElementById('status-number');

    /* ---------------------------
       Header helper: update dynamic member count
       --------------------------- */
    function updateHeaderMemberCount(){
      const el = document.getElementById('header-member-count');
      if (!el) return;
      // use memberProfiles length so it's accurate even if admins are separated
      el.textContent = '~' + (memberProfiles.length || members.length || 0);
    }

    /* ---------------------------
       Render functions
       --------------------------- */
    function renderPinned(){
      pinnedList.innerHTML = '';
      pinned.forEach(p => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '8px';
        li.style.marginBottom = '6px';
        const icon = document.createElement('i');
        icon.setAttribute('data-lucide','pin');
        icon.setAttribute('aria-hidden','true');
        li.appendChild(icon);
        const span = document.createElement('span');
        span.textContent = p;
        span.style.color = 'var(--muted)';
        li.appendChild(span);
        pinnedList.appendChild(li);
      });
    }

    function createFallbackElement(name){
      // Use a seeded placeholder face (pravatar) to make fallback avatars feel mixed and realistic.
      // If the remote image fails, fall back to the initials badge.
      function seedFromName(n){
        let h = 0; if(!n) return 1;
        for(let i=0;i<n.length;i++){ h = ((h<<5) - h) + n.charCodeAt(i); h |= 0; }
        return (Math.abs(h) % 70) + 1; // pravatar supports up to ~70 images
      }

      const seed = seedFromName(name || 'member');

      const img = document.createElement('img');
      img.src = `https://i.pravatar.cc/40?img=${seed}`;
      img.alt = name || 'Member';
      img.style.width = '40px';
      img.style.height = '40px';
      img.style.borderRadius = '10px';
      img.style.objectFit = 'cover';
      img.onerror = function(){
        try { img.remove(); } catch(e){}
        // fallback to initials badge
        const fallback = document.createElement('div');
        fallback.className = 'avatar-fallback';
        fallback.style.width = '40px';
        fallback.style.height = '40px';
        fallback.style.borderRadius = '10px';
        fallback.style.fontSize = '12px';
        fallback.style.flexShrink = '0';
        const parts = (name || '').split(' ').filter(Boolean);
        const initials = (parts.length === 0) ? 'M' : parts.map(s => s[0]).slice(0,2).join('').toUpperCase();
        fallback.textContent = initials;
        // attach to parent if possible
        try { this.parentNode && this.parentNode.appendChild(fallback); } catch(e){}
      };

      // Return a wrapper with the image; callers will append it to the DOM.
      const wrapper = document.createElement('div');
      wrapper.className = 'avatar-wrap';
      wrapper.style.width = '40px';
      wrapper.style.height = '40px';
      wrapper.style.borderRadius = '10px';
      wrapper.style.display = 'inline-block';
      wrapper.style.flexShrink = '0';
      wrapper.appendChild(img);
      return wrapper;
    }

    function createAvatarNodeForProfile(profileOrName){
      let profile = null;
      if (typeof profileOrName === 'string') {
        const s = profileOrName.toLowerCase();
        profile = memberProfiles.find(p => {
          const pn = (p.name || '').toLowerCase();
          return s.includes(pn) || pn.includes(s) || s === pn;
        }) || { name: profileOrName, avatar: null, online: false };
      } else {
        profile = profileOrName;
      }

      const wrap = document.createElement('div');
      wrap.className = 'avatar-wrap';
      wrap.style.width = '40px';
      wrap.style.height = '40px';
      wrap.style.borderRadius = '10px';
      wrap.style.display = 'inline-block';
      wrap.style.flexShrink = '0';

      if (profile && profile.avatar) {
        const img = document.createElement('img');
        img.src = profile.avatar;
        img.alt = profile.name || '';
        img.className = 'round-avatar';
        img.style.width = '40px';
        img.style.height = '40px';
        img.style.borderRadius = '10px';
        img.style.objectFit = 'cover';
        img.onerror = () => {
          try { img.remove(); } catch(e){}
          wrap.appendChild(createFallbackElement(profile.name || 'Member'));
        };
        wrap.appendChild(img);
      } else {
        wrap.appendChild(createFallbackElement(profile.name || 'Member'));
      }

      if (profile && profile.online) {
        const dot = document.createElement('span');
        dot.className = 'online-dot';
        dot.setAttribute('aria-hidden', 'true');
        wrap.appendChild(dot);
      }

      return wrap;
    }

    function renderAdminCard(){
      const admins = memberProfiles.filter(p => p.isAdmin);
      if (admins.length === 0) { adminCardEl.style.display = 'none'; return; }
      adminCardEl.style.display = 'block';
      adminListEl.innerHTML = '';
      admins.forEach(a => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '10px';

        const left = document.createElement('div');
        left.appendChild(createAvatarNodeForProfile(a));
        row.appendChild(left);

        const nameDiv = document.createElement('div');
        nameDiv.style.color = 'var(--muted)';
        nameDiv.style.fontSize = '14px';
        nameDiv.style.display = 'flex';
        nameDiv.style.alignItems = 'center';

        const nameText = document.createElement('span');
        nameText.textContent = a.name;
        nameDiv.appendChild(nameText);

        const badge = document.createElement('span');
        badge.className = 'admin-badge';
        badge.textContent = 'ADMIN';
        nameDiv.appendChild(badge);

        row.appendChild(nameDiv);
        adminListEl.appendChild(row);
      });
      // keep member count accurate
      updateHeaderMemberCount();
    }

    function renderMembers(){
      membersListEl.innerHTML = '';
      // render non-admin members only (admins are shown in admin card)
      const others = memberProfiles.filter(p => !p.isAdmin);
      others.forEach(m => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '10px';

        const left = document.createElement('div');
        left.appendChild(createAvatarNodeForProfile(m));
        row.appendChild(left);

        const nameDiv = document.createElement('div');
        nameDiv.style.color = 'var(--muted)';
        nameDiv.style.fontSize = '14px';
        nameDiv.textContent = m.name;
        row.appendChild(nameDiv);

        membersListEl.appendChild(row);
      });
      // update count each time members are re-rendered
      updateHeaderMemberCount();
    }

    function renderMessages(){
      messagesList.innerHTML = '';
      seededMessages.forEach((m, idx) => {
        const article = document.createElement('article');
        article.style.marginBottom = '8px';
        if(m.role === 'system'){
          article.className = 'msg-system';
          article.textContent = `${m.time} ${m.text}`;
        } else {
          article.className = m.role === 'admin' ? 'msg-admin' : m.role === 'mod' ? 'msg-mod' : 'msg-regular';
          article.style.padding = '12px';
          article.style.borderRadius = '12px';
          const header = document.createElement('div');
          header.style.display = 'flex';
          header.style.justifyContent = 'space-between';
          header.style.alignItems = 'center';

          const left = document.createElement('div');
          left.style.display = 'flex';
          left.style.alignItems = 'center';
          left.style.gap = '10px';

          const profile = memberProfiles.find(p => m.member && p.name && m.member.toLowerCase().includes(p.name.toLowerCase()));
          if (profile) {
            left.appendChild(createAvatarNodeForProfile(profile));
          } else {
            left.appendChild(createAvatarNodeForProfile(m.member));
          }

          const nameDiv = document.createElement('div');
          nameDiv.style.fontWeight = '600';
          nameDiv.style.color = 'var(--text)';
          nameDiv.textContent = m.member || 'Member';
          left.appendChild(nameDiv);

          header.appendChild(left);

          const time = document.createElement('div');
          time.style.color = 'var(--muted)';
          time.style.fontSize = '12px';
          time.textContent = m.time;
          header.appendChild(time);

          const p = document.createElement('p');
          p.style.marginTop = '8px';
          p.style.color = 'var(--text)';
          p.style.fontSize = '14px';
          p.textContent = m.text;

          article.appendChild(header);
          article.appendChild(p);

          const isNewMember = (m.role === 'new') || (m.role === 'system' && m.text && m.text.toLowerCase().includes('new member'));
          if (isNewMember) {
            article.classList.add('highlight-new');
            triggerStatusJoinPulse();
            setTimeout(() => { article.classList.remove('highlight-new'); }, 2400);
          }
        }
        messagesList.appendChild(article);
      });
      // keep scroll pinned to bottom
      try { chatWindow.scrollTop = chatWindow.scrollHeight; } catch(e){}
    }

    /* ---------------------------
       UI interactions (unchanged)
       --------------------------- */
    document.getElementById('copy-pinned').addEventListener('click', async () => {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(pinned.join('\n'));
          alert('Pinned rules copied to clipboard');
        } else {
          // fallback
          const ta = document.createElement('textarea');
          ta.value = pinned.join('\n');
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
          alert('Pinned rules copied to clipboard');
        }
      }
      catch (err) { console.warn('copy failed', err); alert('Unable to copy'); }
    });

    document.getElementById('toggle-notes').addEventListener('click', () => {
      const el = document.getElementById('behavior-notes');
      const isHidden = el.style.display === 'none' || el.style.display === '';
      el.style.display = isHidden ? 'block' : 'none';
      document.getElementById('toggle-notes').setAttribute('aria-expanded', String(isHidden));
    });

    document.getElementById('verify-btn').addEventListener('click', () => {
      document.getElementById('composer-locked').style.display = 'none';
      document.getElementById('composer').style.display = 'flex';
      document.getElementById('composer-text').focus();
    });

    document.getElementById('send-btn').addEventListener('click', () => {
      const txt = document.getElementById('composer-text').value.trim();
      if (!txt) return;
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      seededMessages.push({ time: timeStr, member: 'You', text: txt, role: 'member' });
      document.getElementById('composer-text').value = '';
      renderMessages();
      // after new message appears, update online set deterministically and persist
      const val = parseInt(statusNumberEl.textContent, 10) || 6;
      const list = computeDeterministicOnlineList(val);
      applyOnlineList(list);
      saveOnlineList(list);
      renderMembers();
    });

    document.getElementById('composer-text').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); }
    });

    /* ---------------------------
       Deterministic "online" selection helpers (unchanged)
       --------------------------- */
    function extractAdminNamesFromSeed() {
      const set = new Set();
      seededMessages.forEach(m => {
        if (!m.member || typeof m.member !== 'string') return;
        const low = m.member.toLowerCase();
        if (low.includes('admin')) {
          const paren = m.member.match(/\(([^)]+)\)/);
          if (paren && paren[1]) set.add(paren[1].trim());
          else set.add('admin');
        }
      });
      if (set.has('admin')) {
        seededMessages.forEach(m => {
          if (m.role === 'admin' && m.member && m.member.includes('(')) {
            const par = m.member.match(/\(([^)]+)\)/);
            if (par && par[1]) set.add(par[1].trim());
          }
        });
      }
      return Array.from(set).filter(Boolean);
    }

    function computeDeterministicOnlineList(count){
      const admins = extractAdminNamesFromSeed();
      const onlineSet = new Set();

      const adminProfiles = [];
      admins.forEach(adminName => {
        const prof = memberProfiles.find(p => p.name === adminName || adminName.includes(p.name) || p.name.includes(adminName));
        if (prof) adminProfiles.push(prof.name);
      });
      adminProfiles.forEach(n => onlineSet.add(n));

      const authors = [];
      for (let i = seededMessages.length - 1; i >= 0 && authors.length < count; i--) {
        const m = seededMessages[i];
        if (!m.member || typeof m.member !== 'string') continue;
        const low = m.member.toLowerCase();
        if (low.includes('system')) continue;
        const prof = memberProfiles.find(p => m.member.toLowerCase().includes(p.name.toLowerCase()));
        const nameToAdd = prof ? prof.name : m.member.trim();
        if (!authors.some(a => a.toLowerCase() === nameToAdd.toLowerCase()) && ![...onlineSet].some(s => s.toLowerCase() === nameToAdd.toLowerCase())) {
          authors.push(nameToAdd);
        }
      }

      authors.forEach(a => onlineSet.add(a));

      if (onlineSet.size < count) {
        for (let i = 0; i < memberProfiles.length && onlineSet.size < count; i++) {
          const p = memberProfiles[i];
          if (!onlineSet.has(p.name)) onlineSet.add(p.name);
        }
      }

      return Array.from(onlineSet);
    }

    function applyOnlineList(list){
      memberProfiles.forEach(p => p.online = false);
      list.forEach(item => {
        if (!item) return;
        const it = (item || '').toString().toLowerCase();
        const prof = memberProfiles.find(p => {
          const pn = (p.name || '').toLowerCase();
          return pn === it || pn.includes(it) || it.includes(pn);
        });
        if (prof) prof.online = true;
      });
    }

    /* ---------------------------
       Status & pulses (unchanged)
       --------------------------- */
    function updateStatusNumber(){
      const val = 3 + Math.floor(Math.random() * 6); // 3..8 (display only)
      statusNumberEl.textContent = val;
      const saved = loadOnlineList();
      if (Array.isArray(saved) && saved.length > 0) {
        applyOnlineList(saved);
      } else {
        const list = computeDeterministicOnlineList(val);
        applyOnlineList(list);
        saveOnlineList(list);
      }
      renderMembers();
      renderMessages();
    }

    function triggerStatusJoinPulse(){
      const ring = document.querySelector('.online-indicator .ring');
      const num = document.getElementById('status-number');
      if (ring) {
        ring.classList.add('new-join-pulse');
        setTimeout(()=> ring.classList.remove('new-join-pulse'), 900);
      }
      if (num) {
        num.style.transform = 'scale(1.12)';
        num.style.transition = 'transform 420ms ease-out';
        setTimeout(()=> { num.style.transform = ''; }, 420);
      }
    }

    /* ---------------------------
       Avatar fetching (unchanged)
       --------------------------- */
    async function fetchIranAvatars(){
      try {
        const avatarMap = loadAvatarMap();
        const femaleCount = memberProfiles.filter(p => p.gender === 'female').length;
        const maleCount = memberProfiles.length - femaleCount;
        const totalNeeded = memberProfiles.length;

        const targetFemaleFetch = Math.min(600, Math.ceil(femaleCount * 1.6) + 60);
        const targetMaleFetch = Math.min(600, Math.ceil(maleCount * 1.6) + 60);

        async function fetchPool(gender, results, nat){
          if (results <= 0) return [];
          const natParam = nat ? `&nat=${nat}` : '';
          const url = `https://randomuser.me/api/?gender=${gender}&results=${results}${natParam}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('randomuser fetch failed');
          const json = await res.json();
          const seen = new Set();
          const unique = [];
          (json.results || []).forEach(u => {
            const id = (u.login && u.login.uuid) || u.email || (u.picture && u.picture.large) || null;
            const pic = (u.picture && (u.picture.large || u.picture.medium || u.picture.thumbnail)) || null;
            if (!pic) return;
            if (id && seen.has(id)) return;
            if (pic && Array.from(seen).some(s => s === pic)) return;
            seen.add(id || pic);
            unique.push({ id, pic });
          });
          return unique;
        }

        let femalePool = [], malePool = [];
        try {
          [femalePool, malePool] = await Promise.all([
            fetchPool('female', targetFemaleFetch, 'ir'),
            fetchPool('male', targetMaleFetch, 'ir')
          ]);
        } catch (errNat) {
          console.warn('nat=ir fetch failed, falling back to general fetch', errNat);
          [femalePool, malePool] = await Promise.all([
            fetchPool('female', Math.min(200, targetFemaleFetch), ''),
            fetchPool('male', Math.min(200, targetMaleFetch), '')
          ]);
        }

        let femalePics = femalePool.map(x => x.pic);
        let malePics = malePool.map(x => x.pic);

        function shuffle(a){ for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } }
        shuffle(femalePics); shuffle(malePics);

        memberProfiles.forEach(p => { if (avatarMap[p.name]) p.avatar = avatarMap[p.name]; else p.avatar = null; });

        let fIdx = 0, mIdx = 0;
        for (let i = 0; i < memberProfiles.length; i++) {
          const p = memberProfiles[i];
          if (p.avatar) continue;
          if (p.gender === 'female' && fIdx < femalePics.length) { p.avatar = femalePics[fIdx++]; continue; }
          if (p.gender === 'male' && mIdx < malePics.length) { p.avatar = malePics[mIdx++]; continue; }
          if (fIdx < femalePics.length) { p.avatar = femalePics[fIdx++]; continue; }
          if (mIdx < malePics.length) { p.avatar = malePics[mIdx++]; continue; }
          p.avatar = null;
        }

        const remaining = memberProfiles.filter(p => !p.avatar).length;
        if (remaining > 0) {
          try {
            const pool = await fetchPool('', Math.min(800, remaining * 3 + 80), '');
            const pics = pool.map(x => x.pic);
            shuffle(pics);
            let idx = 0;
            for (let i = 0; i < memberProfiles.length && idx < pics.length; i++) {
              const p = memberProfiles[i];
              if (!p.avatar) { p.avatar = pics[idx++]; }
            }
          } catch (err) {
            console.warn('fallback pool fetch failed', err);
          }
        }

        const used = new Set();
        for (let i = 0; i < memberProfiles.length; i++) {
          const p = memberProfiles[i];
          if (p.avatar) {
            if (used.has(p.avatar)) { p.avatar = null; } else { used.add(p.avatar); }
          }
        }

        const newMap = loadAvatarMap();
        memberProfiles.forEach(p => { if (p.avatar) newMap[p.name] = p.avatar; });
        saveAvatarMap(newMap);

        renderAdminCard(); renderMembers(); renderMessages();
      } catch (err) {
        console.warn('Could not fetch iran avatars:', err);
        renderAdminCard(); renderMembers(); renderMessages();
      }
    }

    /* ---------------------------
       Lucide wiring (unchanged behaviour)
       --------------------------- */
    function wireLucideSvgs(retries = 0){
      const MAX_RETRIES = 12;
      if (window.lucide && typeof lucide.replace === 'function') {
        try { lucide.replace(); } catch(e){}
        document.querySelectorAll('svg.lucide-circle').forEach(svg => {
          svg.classList.add('online-svg');
          try {
            svg.setAttribute('stroke', '#43A047');
            svg.setAttribute('stroke-width', '2.2');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('aria-hidden', 'true');
            svg.style.display = 'inline-block';
          } catch(e){}
        });
        document.querySelectorAll('svg.lucide-pin').forEach(svg => {
          svg.classList.add('pin-svg');
          try {
            svg.setAttribute('stroke', 'var(--muted)');
            svg.setAttribute('stroke-width', '1.6');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('aria-hidden', 'true');
          } catch(e){}
        });
        document.querySelectorAll('svg.lucide-users').forEach(svg => {
          svg.classList.add('users-svg');
          try {
            svg.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#BFBFBF');
            svg.setAttribute('stroke-width', '1.6');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('aria-hidden', 'true');
            svg.style.display = 'inline-block';
            svg.style.width = '18px';
            svg.style.height = '18px';
          } catch(e){}
        });
      } else if (retries < MAX_RETRIES) {
        setTimeout(()=> wireLucideSvgs(retries+1), 180);
      }
    }

    /* ---------------------------
       Admin detection & ordering (unchanged)
       --------------------------- */
    function detectAndMarkAdmins(){
      const rawAdmins = extractAdminNamesFromSeed();
      memberProfiles.forEach(p => {
        const found = rawAdmins.some(a => {
          if (!a) return false;
          const lowerA = a.toLowerCase();
          const lowerP = p.name.toLowerCase();
          return lowerA === lowerP || lowerA.includes(lowerP) || lowerP.includes(lowerA);
        });
        p.isAdmin = !!found;
      });
      updateHeaderMemberCount();
    }

    /* ---------------------------
       Init (unchanged)
       --------------------------- */
    function init(){
      renderPinned();
      detectAndMarkAdmins();

      const avatarMap = loadAvatarMap();
      if (Object.keys(avatarMap).length > 0) {
        memberProfiles.forEach(p => { if (avatarMap[p.name]) p.avatar = avatarMap[p.name]; });
      }

      const savedOnline = loadOnlineList();
      if (Array.isArray(savedOnline) && savedOnline.length > 0) {
        applyOnlineList(savedOnline);
      } else {
        const initialVal = parseInt(statusNumberEl.textContent, 10) || 6;
        const list = computeDeterministicOnlineList(initialVal);
        applyOnlineList(list);
        saveOnlineList(list);
      }

      renderAdminCard(); renderMembers(); renderMessages();
      wireLucideSvgs();
      window.addEventListener('load', () => { setTimeout(()=> wireLucideSvgs(0), 120); });
      fetchIranAvatars();
      setInterval(updateStatusNumber, 5000 + Math.floor(Math.random()*7000));
    }

    init();
  </script>
</body>
</html>
