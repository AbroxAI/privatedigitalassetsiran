<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Private Digital Asset (Iran)</title>

  <!-- Tailwind for layout only -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest/dist/lucide.min.js"></script>

  <style>
    /* -------------------------
       Theme: Quiet Institutional Dark Mode + Soft UI (neumorphism)
       - Subtle inner/outer shadows, soft radiuses, smooth transitions
       ------------------------- */
    :root{
      --bg: #232323;
      --panel: #282828;
      --text: #DADADA;
      --muted: #BFBFBF;
      --divider: rgba(255,255,255,0.03);
      --accent: #43A047;
      --accent-dark: #3d923f;
      --soft-shadow-dark: rgba(0,0,0,0.65);
      --soft-shadow-light: rgba(255,255,255,0.02);
      --soft-elev: 10px 10px 24px rgba(0,0,0,0.55);
      --soft-elev-sm: 6px 6px 18px rgba(0,0,0,0.48);
      --transition: 220ms cubic-bezier(.2,.9,.2,1);
    }

    html,body,#app{height:100%}
    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      margin:0;
    }

    /* Soft UI panels */
    .panel {
      background: var(--panel);
      border-radius: 14px;
      border: 1px solid var(--divider);
      box-shadow:
        8px 8px 20px var(--soft-shadow-dark),
        -6px -6px 16px var(--soft-shadow-light),
        inset 0 1px 0 rgba(255,255,255,0.02);
      transition: box-shadow var(--transition), transform var(--transition);
    }
    .panel:active { transform: translateY(1px); }

    /* Buttons: soft */
    .soft-btn, button {
      border-radius: 10px;
      padding: 8px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
      border: 1px solid rgba(255,255,255,0.02);
      box-shadow:
        4px 6px 14px rgba(0,0,0,0.45),
        inset 0 1px 0 rgba(255,255,255,0.02);
      color: var(--text);
      cursor: pointer;
      transition: transform var(--transition), box-shadow var(--transition), opacity var(--transition);
      font-size: 13px;
    }
    .soft-btn:hover { transform: translateY(-2px); opacity:0.98; }
    .accent-btn {
      background: var(--accent);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow:
        0 6px 18px rgba(0,0,0,0.45),
        inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .accent-btn:hover { filter:brightness(1.02); transform: translateY(-2px); }

    /* Avatar fallback - soft */
    .avatar-fallback {
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
      display:flex; align-items:center; justify-content:center;
      color:var(--text); font-weight:600; text-transform:uppercase;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02), 4px 6px 12px rgba(0,0,0,0.48);
    }

    /* Avatar wrapper + online dot */
    .avatar-wrap { position: relative; width:40px; height:40px; flex-shrink:0; display:inline-block; border-radius:12px; overflow:hidden; }
    .avatar-wrap img, .avatar-wrap .avatar-fallback { width:40px; height:40px; border-radius:10px; object-fit:cover; display:block; }
    .online-dot {
      position: absolute;
      right: -2px;
      bottom: -2px;
      width:14px;
      height:14px;
      border-radius:9999px;
      background: var(--accent);
      border: 3px solid var(--panel);
      box-shadow: 0 6px 18px rgba(67,160,71,0.14);
      transform-origin: 50% 50%;
      animation: blinkPulse 1.6s infinite ease-in-out;
    }

    @keyframes blinkPulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.45; transform: scale(1.08); }
      100% { opacity: 1; transform: scale(1); }
    }

    .online-svg { width: 14px; height: 14px; color: var(--accent); animation: blinkPulse 1.6s infinite ease-in-out; }

    .status-number { animation: numberPulse 2200ms infinite ease-in-out; color: var(--accent-dark); font-weight:700; }
    @keyframes numberPulse { 0% { transform: translateY(0); } 50% { transform: translateY(-1px) scale(1.02); } 100% { transform: translateY(0); } }

    /* Messages - slightly softened cards */
    .msg-admin { background: rgba(255,255,255,0.01); border-left:4px solid rgba(74,144,226,0.06); padding:12px; border-radius:12px; box-shadow: 4px 6px 18px rgba(0,0,0,0.45); }
    .msg-mod { background: rgba(255,255,255,0.01); border-left:4px solid rgba(120,120,120,0.06); padding:12px; border-radius:12px; box-shadow: 4px 6px 18px rgba(0,0,0,0.45); }
    .msg-regular { background: rgba(255,255,255,0.01); padding:12px; border-radius:12px; box-shadow: 4px 6px 18px rgba(0,0,0,0.45); }
    .msg-system { font-style: italic; color: #9CA3AF; padding: 8px; }

    .highlight-new { animation: newJoinHighlight 2000ms ease-in-out forwards; border-radius: 12px; }
    @keyframes newJoinHighlight {
      0% { box-shadow: 0 0 0 rgba(67,160,71,0); transform: scale(1); background-color: transparent; }
      12% { background-color: rgba(67,160,71,0.03); transform: scale(1.006); }
      60% { box-shadow: 0 20px 40px rgba(67,160,71,0.07); transform: scale(1.01); }
      100% { box-shadow: 0 0 0 rgba(67,160,71,0); transform: scale(1); background-color: transparent; }
    }

    /* subtle admin badge (realistic pill) */
    .admin-badge {
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:var(--text);
      padding:4px 8px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(67,160,71,0.12), rgba(67,160,71,0.06));
      border: 1px solid rgba(67,160,71,0.14);
      box-shadow: 0 4px 12px rgba(67,160,71,0.06);
      font-weight:700;
    }
    .admin-badge .dot { width:8px; height:8px; border-radius:999px; background:var(--accent); box-shadow:0 4px 8px rgba(67,160,71,0.12); }

    /* Header layout tweaks so logo sits top-right and bold */
    .header-row { display:flex; align-items:center; justify-content:space-between; gap:16px; width:100%; }
    .left-meta { display:flex; flex-direction:column; gap:6px; flex:1; min-width:0; }
    .right-meta { display:flex; align-items:center; gap:12px; justify-content:flex-end; flex-shrink:0; }

    /* TWEAKED: make logo bigger and more prominent/readable */
    .header-logo-wrap { display:inline-flex; align-items:center; justify-content:center; flex-shrink:0; align-self:flex-start; margin-left:0; margin-right:12px; }
    .header-logo {
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04));
      width:88px; height:88px;
      box-shadow: 12px 14px 36px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      object-fit:contain;
      padding:8px;
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .header-logo:hover { transform: translateY(-3px) scale(1.02); box-shadow: 14px 18px 42px rgba(0,0,0,0.7); }

    .header-logo-fallback {
      width:88px; height:88px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:14px; background:#111; color:#fff; font-weight:900; font-size:18px;
      border:1px solid rgba(255,255,255,0.04);
      box-shadow: 12px 14px 36px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
    }

    /* Online indicator */
    .online-indicator { width: 18px; height:18px; display:inline-block; position:relative; flex-shrink:0; margin-right:6px; }
    .online-indicator .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--accent); box-shadow: 0 6px 16px rgba(67,160,71,0.16); position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
    .online-indicator .ring { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:14px; height:14px; border-radius:50%; border:1px solid rgba(67,160,71,0.12); box-sizing:border-box; animation: onlinePulse 1600ms infinite ease-in-out; }
    @keyframes onlinePulse { 0% { transform: translate(-50%,-50%) scale(1); opacity:1; } 50% { transform: translate(-50%,-50%) scale(1.12); opacity:0.45; } 100% { transform: translate(-50%,-50%) scale(1); opacity:1; } }

    /* Stat boxes with soft depth */
    .meta-stats { display:flex; gap:12px; align-items:center; }
    .stat-box {
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border-radius:12px;
      border: 1px solid rgba(255,255,255,0.02);
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));
      min-width:120px;
      box-shadow: var(--soft-elev-sm);
      transition: transform var(--transition), box-shadow var(--transition);
    }
    .stat-box:hover { transform: translateY(-3px); box-shadow: var(--soft-elev); }
    .stat-icon { display:inline-flex; align-items:center; justify-content:center; width:28px; height:28px; flex-shrink:0; border-radius:8px; background:rgba(0,0,0,0.04); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
    .stat-text { display:flex; flex-direction:column; line-height:1; text-align:left; }
    .stat-text .muted { font-size:12px; color:var(--muted); }
    .stat-text .count { font-weight:700; color:var(--text); font-size:15px; }

    .users-badge {
      width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:10px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.04));
      border: 1px solid rgba(255,255,255,0.02);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02), 6px 8px 18px rgba(0,0,0,0.45);
      flex-shrink:0;
    }

    /* Fallback users SVG visible by default; hidden once lucide injects its svg */
    .users-fallback-svg { width:20px; height:20px; display:inline-block; stroke:var(--muted); stroke-width:1.6; fill:none; }
    /* if lucide produced an svg inside the badge, hide fallback */
    .users-badge svg.lucide-users + .users-fallback-svg { display:none; }
    /* if lucide produced an svg and it replaced the <i>, then the svg will be the first child; hide fallback when any svg is present */
    .users-badge svg + .users-fallback-svg { display:none; }

    /* Textareas and inputs: soft inner shadow */
    textarea, input[type="text"], input[type="search"] {
      background: var(--panel);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.02);
      padding: 10px;
      box-shadow: inset 4px 6px 16px rgba(0,0,0,0.55), inset -2px -2px 8px rgba(255,255,255,0.01);
      color: var(--text);
      transition: box-shadow var(--transition), transform var(--transition);
      resize: vertical;
    }
    textarea:focus, input:focus { outline: none; box-shadow: 0 14px 40px rgba(0,0,0,0.6); transform: translateY(-1px); }

    /* responsiveness */
    @media (max-width:900px){
      .header-logo { width:72px; height:72px; padding:6px; }
      .header-logo-fallback { width:72px; height:72px; font-size:15px; }
      .users-badge { width:30px; height:30px; }
      .stat-box { padding:8px 10px; min-width:100px; }
    }
    @media (max-width:640px){
      .header-logo { width:64px; height:64px; padding:6px; }
      .header-logo-fallback { width:64px; height:64px; font-size:14px; }
      .right-meta { gap:10px; }
      .meta-stats { gap:8px; }
    }
    @media (max-width:420px){
      .header-row { flex-direction:column; align-items:stretch; gap:10px; }
      .right-meta { justify-content:space-between; }
      .meta-stats { width:100%; justify-content:space-between; }
      .header-logo-wrap { align-self:flex-end; margin-left:0; }
    }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen p-4 md:p-8">
    <header class="mb-4" role="banner">
      <div class="header-row">
        <!-- LEFT: title + meta -->
        <div class="left-meta">
          <h1 id="group-title" class="text-xl md:text-2xl font-semibold" style="color:var(--text); margin:0">Private Digital Asset (Iran)</h1>
          <div class="text-sm" style="color:var(--muted);">
            <!-- updated period to 8 January 2026 — 15 May 2026 -->
            <span id="date-range">Period: 8 January 2026 — 15 May 2026</span>
          </div>
        </div>

        <!-- RIGHT: members + status + logo -->
        <div class="right-meta" aria-hidden="false">
          <div class="meta-stats" role="group" aria-label="Group quick stats">
            <div class="stat-box" id="members-box" aria-hidden="false">
              <div class="users-badge stat-icon" aria-hidden="true">
                <!-- keep the lucide hook so lucide.replace() can swap it with an svg -->
                <i data-lucide="users" aria-hidden="true"></i>

                <!-- fallback inline svg: visible if lucide hasn't injected an icon yet -->
                <svg class="users-fallback-svg" viewBox="0 0 24 24" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" role="img">
                  <!-- simple two-person icon -->
                  <path d="M16 11c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM8 11c1.657 0 3-1.343 3-3S9.657 5 8 5 5 6.343 5 8s1.343 3 3 3z" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M2 20c0-2.21 3.134-4 7-4s7 1.79 7 4M18 20v-1c0-1.657-2.686-3-6-3M8 20v-1c0-1.657 2.686-3 6-3" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </div>
              <div class="stat-text" style="min-width:70px;">
                <div class="muted">Members</div>
                <div id="header-member-count" class="count">~140</div>
              </div>
            </div>

            <div class="stat-box" id="status-box" aria-hidden="false" style="min-width:150px; justify-content:flex-end;">
              <div style="display:flex; align-items:center; gap:10px;">
                <div class="online-indicator" aria-hidden="true" title="Online">
                  <div class="ring"></div>
                  <div class="dot"></div>
                </div>
                <div style="text-align:left;">
                  <div class="muted" style="font-size:12px;">Status</div>
                  <div id="status-text" class="text-sm" style="color:var(--text); font-weight:600;">Active now: <span id="status-number" class="status-number">6</span></div>
                </div>
              </div>
            </div>
          </div>

          <!-- SITE LOGO placed to the far right; bold and scaled -->
          <a href="/" class="header-logo-wrap" aria-label="Private Digital Asset logo" title="Private Digital Asset">
            <img
              id="site-logo"
              src="assets/logo.png"
              alt="Private Digital Asset logo"
              width="88" height="88"
              decoding="async"
              loading="eager"
              class="header-logo"
              onerror="(function(el){ el.style.display='none'; try{ var f = document.createElement('div'); f.className='header-logo-fallback'; f.textContent='PDA'; el.parentNode && el.parentNode.appendChild(f);}catch(e){} })(this);"
            />
          </a>
        </div>
      </div>
    </header>

    <main class="flex flex-1 flex-col md:flex-row gap-4">
      <section class="flex-1 flex flex-col panel overflow-hidden">
        <div class="p-4 border-b" style="border-color:var(--divider); display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="text-sm font-medium" style="color:var(--text)">PINNED CONTENT (always visible)</div>
            <ul id="pinned-list" class="mt-2 text-sm" style="color:var(--muted); list-style:none; padding-left:0; gap:6px;"></ul>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
            <button id="copy-pinned" class="soft-btn" style="background:transparent; border-color:var(--divider); color:var(--text); font-size:12px;">Copy</button>
            <button id="toggle-notes" class="soft-btn" style="background:transparent; border-color:var(--divider); color:var(--text); font-size:12px;" aria-expanded="false">Notes</button>
          </div>
        </div>

        <div id="chat-window" class="p-4 flex-1 overflow-auto" role="log" aria-live="polite">
          <div id="messages-list" class="space-y-3"></div>
        </div>

        <div class="p-4 border-t" style="border-color:var(--divider); background:transparent;">
          <div id="composer-locked" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <div style="color:var(--muted)">Posting is locked until verification. Please request verification to post.</div>
            <div>
              <button id="verify-btn" class="accent-btn" style="padding:8px 10px; border-radius:10px;">Request verification</button>
            </div>
          </div>

          <div id="composer" class="hidden" style="display:flex; gap:12px; margin-top:8px; align-items:flex-start;">
            <textarea id="composer-text" placeholder="Type a message — Enter to send" class="flex-1" style="padding:12px; border-radius:12px; border:1px solid var(--divider); background:var(--panel); color:var(--text); min-height:64px;"></textarea>
            <div>
              <button id="send-btn" class="accent-btn" style="padding:8px 12px; border-radius:10px;">Send</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="w-full md:w-72 flex-shrink-0 panel p-4">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
          <h2 style="font-weight:600; color:var(--text); font-size:14px;">MEMBERS (names)</h2>
          <span style="color:var(--muted); font-size:12px;">Realistic view</span>
        </div>

        <!-- Admin card pinned to top -->
        <div id="admin-card" class="admin-card" style="display:none;">
          <div class="admin-title">ADMINS</div>
          <div id="admin-list" style="display:flex; flex-direction:column; gap:8px;"></div>
        </div>

        <div id="members-list" style="display:flex; flex-direction:column; gap:10px; color:var(--muted);"></div>
      </aside>
    </main>

    <div id="behavior-notes" class="panel" style="display:none; margin-top:16px; padding:12px; color:var(--muted);">
      <h3 style="color:var(--text); font-weight:600;">REALISTIC CHAT PARTICIPATION (pattern & stats)</h3>
      <pre style="white-space:pre-wrap; color:var(--muted)">(Overview & instructor notes stored in the script)</pre>
    </div>

  </div>

  <script>
    /************************************************************************
     * Full script preserved + Flow simulation.
     * Visual-only, non-destructive additions:
     * - simulateFlows() to set Day 1/Day 2/Day4/Day7 timeline when no persisted messages.
     * - Everything else left intact (avatars, lucide, BroadcastChannel, persistence).
     ************************************************************************/

    /* ---------------------------
       Pinned content
       --------------------------- */
    const pinned = [
      "Privacy rules (Iran-focused)",
      "Verification required to participate in sensitive discussions",
      "Group purpose: protect asset value, not investment advice",
      "No screenshots or forwarding",
      "Sensitive questions → DM the admin"
    ];

    /* ---------------------------
       Members (140) - unchanged names list
       --------------------------- */
    const members = [
      "Ariamen Niknam","Zhinos Farmani","Misaq Dashti","Pardis Sohrabi","Pouyan Tarabnia","Zhaleh Pourbakhtiar","Derina Kermani","Sohrab Mehrayin","Sepand Yaghmaei","Bakhtiar Kohandel",
      "Taraneh Rozbehani","Saman Tihu","Padideh Naderi","Niko Foroughi","Hamoon Zagros","Naysabeh Tahmasbi","Diana Siavoshi","Bahman Azarpi","Negin Koneshlu","Rosta Mehrayin",
      "Saman-yar Ahoui","Yara Zhilavand","Parsa Shayeg","Mahraz Golestani","Siamak Hoorami","Helia Mahinpour","Nima Taban","Parvosh Ramyar","Hooshang Bahari","Naghmeh Soroush",
      "Kourosh Nikmanesh","Kian Rudbar","Narges Delaram","Sudeh Kianpour","Amin Shayegan","Niloufar Behrbakhsh","Soha Armaghani","Dara Firoozi","Zhila Mehraban","Samyar Rudgar",
      "Mahrokh Khodadadi","Nava Sayad","Parmida Sahli","Parham Soleimani-Nejad","Sepideh Nikandish","Pegah Derakhshan","Toranj Keyvani","Shahin Pejmanfar","Sheyda Alavi","Hoshmand Kateb",
      "Mojgan Forouhar","Ahura Bahrami","Azadeh Nistani","Farshid Yousefi","Yeganeh Semnani","Siros Padidar","Ainaz Goodarzi","Mani Arashid","Roonak Ghaffari","Radin Sepehri",
      "Mahshad Barghaei","Keyvan Rostami","Nazanin Dehghani","Homa Nadali","Nira Eghbali","Pouyan Kohanzad","Matiah Khoramdel","Baran Jamshidi","Kiarash Mardani","Zaria Farhang",
      "Dihim Nazari","Behnam Alghasi","Golareh Malkani","Koroshian Tarkan","Raha Beheshti","Soheil Nikkhah","Zhaki Zhalehpoor","Rambod Hejri","Shaparak Fallahi","Kamyar Homayounfar",
      "Tarlan Daryabigi","Kimia Khojasteh","Pouya Nasrollahi","Mahyar Farahani","Ladan Soleimani","Niusha Mehraban","Sina Khaleghi","Golsa Shayegan","Abtin Kamali","Farnaz Bahrampour",
      "Mehrangiz Rabiei","Arshan Mahdavi","Yasaman Azarban","Shervin Ganji","Tarnam Mahasti","Arshin Boroumand","Nikzad Shahidi","Bahareh Sirafi","Kikavous Niknami","Mehrnoush Azargun",
      "Parsa Delshad","Zhubin Razaqi","Tahmineh Nikkhah","Houtan Delpak","Roya Danaei","Niloufar Shahryar","Zhyar Kamyab","Mina Salimi","Shayan Mazinani","Diana Farahmand",
      "Arian Mehranfar","Yekta Feyzi","Naderah Pasandideh","Kianoush Damghani","Azadeh Mehrgostar","Samdel Shahrokhi","Mahtab Forouzh","Shayan Nikpour","Koraogh Lilizad","Hamasin Kouhi",
      "Pouyan Zanganeh","Ramin Yarmohammadi","Niloufar Arshidi","Gerard Golchin","Hooman Panjabi","Rana Keyvani","Shahrooz Mehrabi","Minoudokht Bahrami","Adrian Feyzabad","Zarrin Golmohammadi",
      "Farshad Kamkar","Pegah Naderian","Arzu Farozand","Delara Niri","Niko Golrokh","Sepehr Nikrosh","Samaneh Arvand","Yousef Rouzbeh","Mahtab Nobahar","Pedram Shakiba"
    ];

    /* ---------------------------
       Seeded messages (kept as variable — simulateFlows will replace only if no saved messages)
       --------------------------- */
    let seededMessages = [
      { time: "08:57", member: "System", text: "You joined the group.", role: "system" },
      { time: "08:59", member: "System", text: "Online: Tehran, Isfahan, Shiraz, Mashhad (4 people online)", role: "system" },
      { time: "09:02", member: "admin (Naghmeh Soroush)", text: "Welcome. Please read the pinned rules.", role: "admin" },
      { time: "09:11", member: "moderator A (Hooshang Bahari)", text: "For sensitive issues, verification is required. DM the admin.", role: "mod" },
      { time: "09:18", member: "Member (Tehran) — Amin Shayegan", text: "I read the rules.", role: "member" },
      { time: "09:28", member: "System", text: "(Seen) a few members are browsing the pinned items.", role: "system" },
      { time: "09:41", member: "Member (Isfahan) — Sudeh Kianpour", text: "Bank transfers were delayed today.", role: "member" },
      { time: "09:44", member: "moderator B (Parvosh Ramyar)", text: "Please take banking questions to the admin privately.", role: "mod" }
    ];

    /* ---------------------------
       Avatar heuristics & helpers (unchanged)
       --------------------------- */
    const femaleTokens = [
      "zhaleh","derina","taraneh","padideh","niko","naysabeh","diana","negin","yara","narges",
      "sudeh","niloufar","pegah","shaparak","mina","roonak","zaria","mojgan","azadeh","yasaman",
      "delara","bahareh","mehrnoush","zarrin","mahtab","niusha","golsa","yekta","nazanin","homa",
      "farah","parida","parisa","soheila","zahra","fatemeh","marjan","sara","roxana","rosta"
    ];
    function looksFemale(name){ if(!name) return false; const lower=name.toLowerCase(); return femaleTokens.some(t=>lower.includes(t)); }
    function randInt(max){ return Math.floor(Math.random()*max); }

    // memberProfiles now include gender and online props; isAdmin set later
    let memberProfiles = members.map(name => ({ name, avatar: null, gender: looksFemale(name) ? 'female' : 'male', online: false, isAdmin: false }));

    /* ---------------------------
       localStorage helpers for avatar persistence and online list
       --------------------------- */
    const AVATAR_MAP_KEY = 'group_avatar_map_v1';
    const ONLINE_LIST_KEY = 'group_online_list_v1';
    const MESSAGES_KEY = 'group_messages_v1';

    function loadAvatarMap(){
      try { const raw = localStorage.getItem(AVATAR_MAP_KEY); return raw ? JSON.parse(raw) : {}; } catch(e){ return {}; }
    }
    function saveAvatarMap(map){
      try { localStorage.setItem(AVATAR_MAP_KEY, JSON.stringify(map)); } catch(e){}
    }

    function loadOnlineList(){
      try { const raw = localStorage.getItem(ONLINE_LIST_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }
    function saveOnlineList(list){
      try { localStorage.setItem(ONLINE_LIST_KEY, JSON.stringify(list)); } catch(e){}
    }

    function loadMessages(){
      try { const raw = localStorage.getItem(MESSAGES_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
    }
    function saveMessages(arr){
      try { localStorage.setItem(MESSAGES_KEY, JSON.stringify(arr)); } catch(e){}
    }

    /* ---------------------------
       BroadcastChannel for local-real-time (tabs) sync (unchanged)
       --------------------------- */
    const CHANNEL_NAME = 'abrox-group-chat';
    let bc = null;
    try {
      if ('BroadcastChannel' in window) {
        bc = new BroadcastChannel(CHANNEL_NAME);
        bc.addEventListener('message', (ev) => {
          try {
            const data = ev.data;
            if (!data || !data.type) return;
            if (data.type === 'new-message' && data.payload) {
              const exists = seededMessages.some(m => m.time === data.payload.time && m.member === data.payload.member && m.text === data.payload.text);
              if (!exists) {
                seededMessages.push(data.payload);
                saveMessages(seededMessages);
                const val = parseInt(statusNumberEl.textContent, 10) || 6;
                const list = computeDeterministicOnlineList(val);
                applyOnlineList(list);
                renderMessages();
                renderMembers();
              }
            } else if (data.type === 'replace-messages' && Array.isArray(data.payload)) {
              seededMessages = data.payload.slice();
              saveMessages(seededMessages);
              renderMessages();
              renderMembers();
            }
          } catch (e) { console.warn('bc message handler err', e); }
        });
      }
    } catch (e) { console.warn('BroadcastChannel init failed', e); bc = null; }

    /* ---------------------------
       DOM refs
       --------------------------- */
    const pinnedList = document.getElementById('pinned-list');
    const membersListEl = document.getElementById('members-list');
    const adminCardEl = document.getElementById('admin-card');
    const adminListEl = document.getElementById('admin-list');
    const messagesList = document.getElementById('messages-list');
    const chatWindow = document.getElementById('chat-window');
    const statusNumberEl = document.getElementById('status-number');

    /* ---------------------------
       Header helper: update dynamic member count
       --------------------------- */
    function updateHeaderMemberCount(){
      const el = document.getElementById('header-member-count');
      if (!el) return;
      el.textContent = '~' + (memberProfiles.length || members.length || 0);
    }

    /* ---------------------------
       Render functions (unchanged)
       --------------------------- */
    function renderPinned(){
      pinnedList.innerHTML = '';
      pinned.forEach(p => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '8px';
        li.style.marginBottom = '6px';
        const icon = document.createElement('i');
        icon.setAttribute('data-lucide','pin');
        icon.setAttribute('aria-hidden','true');
        li.appendChild(icon);
        const span = document.createElement('span');
        span.textContent = p;
        span.style.color = 'var(--muted)';
        li.appendChild(span);
        pinnedList.appendChild(li);
      });
    }

    function createFallbackElement(name){
      function seedFromName(n){
        let h = 0; if(!n) return 1;
        for(let i=0;i<n.length;i++){ h = ((h<<5) - h) + n.charCodeAt(i); h |= 0; }
        return (Math.abs(h) % 70) + 1;
      }

      const seed = seedFromName(name || 'member');

      const img = document.createElement('img');
      img.src = `https://i.pravatar.cc/40?img=${seed}`;
      img.alt = name || 'Member';
      img.style.width = '40px';
      img.style.height = '40px';
      img.style.borderRadius = '10px';
      img.style.objectFit = 'cover';
      img.onerror = function(){
        try { img.remove(); } catch(e){}
        const fallback = document.createElement('div');
        fallback.className = 'avatar-fallback';
        fallback.style.width = '40px';
        fallback.style.height = '40px';
        fallback.style.borderRadius = '10px';
        fallback.style.fontSize = '12px';
        fallback.style.flexShrink = '0';
        const parts = (name || '').split(' ').filter(Boolean);
        const initials = (parts.length === 0) ? 'M' : parts.map(s => s[0]).slice(0,2).join('').toUpperCase();
        fallback.textContent = initials;
        try { this.parentNode && this.parentNode.appendChild(fallback); } catch(e){}
      };

      const wrapper = document.createElement('div');
      wrapper.className = 'avatar-wrap';
      wrapper.style.width = '40px';
      wrapper.style.height = '40px';
      wrapper.style.borderRadius = '10px';
      wrapper.style.display = 'inline-block';
      wrapper.style.flexShrink = '0';
      wrapper.appendChild(img);
      return wrapper;
    }

    function createAvatarNodeForProfile(profileOrName){
      let profile = null;
      if (typeof profileOrName === 'string') {
        const s = profileOrName.toLowerCase();
        profile = memberProfiles.find(p => {
          const pn = (p.name || '').toLowerCase();
          return s.includes(pn) || pn.includes(s) || s === pn;
        }) || { name: profileOrName, avatar: null, online: false };
      } else {
        profile = profileOrName;
      }

      const wrap = document.createElement('div');
      wrap.className = 'avatar-wrap';
      wrap.style.width = '40px';
      wrap.style.height = '40px';
      wrap.style.borderRadius = '10px';
      wrap.style.display = 'inline-block';
      wrap.style.flexShrink = '0';

      if (profile && profile.avatar) {
        const img = document.createElement('img');
        img.src = profile.avatar;
        img.alt = profile.name || '';
        img.className = 'round-avatar';
        img.style.width = '40px';
        img.style.height = '40px';
        img.style.borderRadius = '10px';
        img.style.objectFit = 'cover';
        img.onerror = () => {
          try { img.remove(); } catch(e){}
          wrap.appendChild(createFallbackElement(profile.name || 'Member'));
        };
        wrap.appendChild(img);
      } else {
        wrap.appendChild(createFallbackElement(profile.name || 'Member'));
      }

      if (profile && profile.online) {
        const dot = document.createElement('span');
        dot.className = 'online-dot';
        dot.setAttribute('aria-hidden', 'true');
        wrap.appendChild(dot);
      }

      return wrap;
    }

    function renderAdminCard(){
      const admins = memberProfiles.filter(p => p.isAdmin);
      if (admins.length === 0) { adminCardEl.style.display = 'none'; return; }
      adminCardEl.style.display = 'block';
      adminListEl.innerHTML = '';
      admins.forEach(a => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '10px';

        const left = document.createElement('div');
        left.appendChild(createAvatarNodeForProfile(a));
        row.appendChild(left);

        const nameDiv = document.createElement('div');
        nameDiv.style.color = 'var(--muted)';
        nameDiv.style.fontSize = '14px';
        nameDiv.style.display = 'flex';
        nameDiv.style.alignItems = 'center';
        nameDiv.style.gap = '8px';

        const nameText = document.createElement('span');
        nameText.textContent = a.name;
        nameDiv.appendChild(nameText);

        const badge = document.createElement('span');
        badge.className = 'admin-badge';
        badge.innerHTML = '<span class=\"dot\"></span><span style=\"opacity:0.9; margin-left:4px; font-weight:700;\">ADMIN</span>';
        nameDiv.appendChild(badge);

        row.appendChild(nameDiv);
        adminListEl.appendChild(row);
      });
      updateHeaderMemberCount();
    }

    function renderMembers(){
      membersListEl.innerHTML = '';
      const others = memberProfiles.filter(p => !p.isAdmin);
      others.forEach(m => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '10px';

        const left = document.createElement('div');
        left.appendChild(createAvatarNodeForProfile(m));
        row.appendChild(left);

        const nameDiv = document.createElement('div');
        nameDiv.style.color = 'var(--muted)';
        nameDiv.style.fontSize = '14px';
        nameDiv.textContent = m.name;
        row.appendChild(nameDiv);

        membersListEl.appendChild(row);
      });
      updateHeaderMemberCount();
    }

    function renderMessages(){
      messagesList.innerHTML = '';
      seededMessages.forEach((m, idx) => {
        const article = document.createElement('article');
        article.style.marginBottom = '8px';
        if(m.role === 'system'){
          article.className = 'msg-system';
          article.textContent = `${m.time} ${m.text}`;
        } else {
          article.className = m.role === 'admin' ? 'msg-admin' : m.role === 'mod' ? 'msg-mod' : 'msg-regular';
          article.style.padding = '12px';
          article.style.borderRadius = '12px';
          const header = document.createElement('div');
          header.style.display = 'flex';
          header.style.justifyContent = 'space-between';
          header.style.alignItems = 'center';

          const left = document.createElement('div');
          left.style.display = 'flex';
          left.style.alignItems = 'center';
          left.style.gap = '10px';

          const profile = memberProfiles.find(p => m.member && p.name && m.member.toLowerCase().includes(p.name.toLowerCase()));
          if (profile) {
            left.appendChild(createAvatarNodeForProfile(profile));
          } else {
            left.appendChild(createAvatarNodeForProfile(m.member));
          }

          const nameDiv = document.createElement('div');
          nameDiv.style.fontWeight = '600';
          nameDiv.style.color = 'var(--text)';
          nameDiv.textContent = m.member || 'Member';
          left.appendChild(nameDiv);

          header.appendChild(left);

          const time = document.createElement('div');
          time.style.color = 'var(--muted)';
          time.style.fontSize = '12px';
          time.textContent = m.time;
          header.appendChild(time);

          const p = document.createElement('p');
          p.style.marginTop = '8px';
          p.style.color = 'var(--text)';
          p.style.fontSize = '14px';
          p.textContent = m.text;

          article.appendChild(header);
          article.appendChild(p);

          const isNewMember = (m.role === 'new') || (m.role === 'system' && m.text && m.text.toLowerCase().includes('new member'));
          if (isNewMember) {
            article.classList.add('highlight-new');
            triggerStatusJoinPulse();
            setTimeout(() => { article.classList.remove('highlight-new'); }, 2400);
          }
        }
        messagesList.appendChild(article);
      });
      try { chatWindow.scrollTop = chatWindow.scrollHeight; } catch(e){}
    }

    /* ---------------------------
       UI interactions (unchanged)
       --------------------------- */
    document.getElementById('copy-pinned').addEventListener('click', async () => {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(pinned.join('\n'));
          alert('Pinned rules copied to clipboard');
        } else {
          const ta = document.createElement('textarea');
          ta.value = pinned.join('\n');
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
          alert('Pinned rules copied to clipboard');
        }
      }
      catch (err) { console.warn('copy failed', err); alert('Unable to copy'); }
    });

    document.getElementById('toggle-notes').addEventListener('click', () => {
      const el = document.getElementById('behavior-notes');
      const isHidden = el.style.display === 'none' || el.style.display === '';
      el.style.display = isHidden ? 'block' : 'none';
      document.getElementById('toggle-notes').setAttribute('aria-expanded', String(isHidden));
    });

    document.getElementById('verify-btn').addEventListener('click', () => {
      document.getElementById('composer-locked').style.display = 'none';
      document.getElementById('composer').style.display = 'flex';
      document.getElementById('composer-text').focus();
    });

    document.getElementById('send-btn').addEventListener('click', () => {
      const txt = document.getElementById('composer-text').value.trim();
      if (!txt) return;
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const newMsg = { time: timeStr, member: 'You', text: txt, role: 'member' };

      // preserve original behavior: push, re-render
      seededMessages.push(newMsg);

      // save messages locally so they persist across reloads
      saveMessages(seededMessages);

      // broadcast to other tabs (if available)
      if (bc) {
        try { bc.postMessage({ type: 'new-message', payload: newMsg }); } catch(e){ console.warn('bc post err', e); }
      }

      document.getElementById('composer-text').value = '';
      renderMessages();

      // recompute online list & persist (keeps original logic path intact)
      const val = parseInt(statusNumberEl.textContent, 10) || 6;
      const list = computeDeterministicOnlineList(val);
      applyOnlineList(list);
      saveOnlineList(list);
      renderMembers();
    });

    document.getElementById('composer-text').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); }
    });

    /* ---------------------------
       Deterministic "online" selection helpers (unchanged)
       --------------------------- */
    function extractAdminNamesFromSeed() {
      const set = new Set();
      seededMessages.forEach(m => {
        if (!m.member || typeof m.member !== 'string') return;
        const low = m.member.toLowerCase();
        if (low.includes('admin')) {
          const paren = m.member.match(/\(([^)]+)\)/);
          if (paren && paren[1]) set.add(paren[1].trim());
          else set.add('admin');
        }
      });
      if (set.has('admin')) {
        seededMessages.forEach(m => {
          if (m.role === 'admin' && m.member && m.member.includes('(')) {
            const par = m.member.match(/\(([^)]+)\)/);
            if (par && par[1]) set.add(par[1].trim());
          }
        });
      }
      return Array.from(set).filter(Boolean);
    }

    function computeDeterministicOnlineList(count){
      const admins = extractAdminNamesFromSeed();
      const onlineSet = new Set();

      const adminProfiles = [];
      admins.forEach(adminName => {
        const prof = memberProfiles.find(p => p.name === adminName || adminName.includes(p.name) || p.name.includes(adminName));
        if (prof) adminProfiles.push(prof.name);
      });
      adminProfiles.forEach(n => onlineSet.add(n));

      const authors = [];
      for (let i = seededMessages.length - 1; i >= 0 && authors.length < count; i--) {
        const m = seededMessages[i];
        if (!m.member || typeof m.member !== 'string') continue;
        const low = m.member.toLowerCase();
        if (low.includes('system')) continue;
        const prof = memberProfiles.find(p => m.member.toLowerCase().includes(p.name.toLowerCase()));
        const nameToAdd = prof ? prof.name : m.member.trim();
        if (!authors.some(a => a.toLowerCase() === nameToAdd.toLowerCase()) && ![...onlineSet].some(s => s.toLowerCase() === nameToAdd.toLowerCase())) {
          authors.push(nameToAdd);
        }
      }

      authors.forEach(a => onlineSet.add(a));

      if (onlineSet.size < count) {
        for (let i = 0; i < memberProfiles.length && onlineSet.size < count; i++) {
          const p = memberProfiles[i];
          if (!onlineSet.has(p.name)) onlineSet.add(p.name);
        }
      }

      return Array.from(onlineSet);
    }

    function applyOnlineList(list){
      memberProfiles.forEach(p => p.online = false);
      list.forEach(item => {
        if (!item) return;
        const it = (item || '').toString().toLowerCase();
        const prof = memberProfiles.find(p => {
          const pn = (p.name || '').toLowerCase();
          return pn === it || pn.includes(it) || it.includes(pn);
        });
        if (prof) prof.online = true;
      });
    }

    /* ---------------------------
       Status number fluctuation & join pulse (unchanged)
       --------------------------- */
    function updateStatusNumber(){
      const val = 3 + Math.floor(Math.random() * 6); // 3..8
      const statEl = document.getElementById('status-number');
      if (statEl) statEl.textContent = val;
      const saved = loadOnlineList();
      if (Array.isArray(saved) && saved.length > 0) {
        applyOnlineList(saved);
      } else {
        const list = computeDeterministicOnlineList(val);
        applyOnlineList(list);
        saveOnlineList(list);
      }
      renderMembers();
      renderMessages();
    }

    function triggerStatusJoinPulse(){
      const ring = document.querySelector('.online-indicator .ring');
      const num = document.getElementById('status-number');
      if (ring) {
        ring.classList.add('new-join-pulse');
        setTimeout(()=> ring.classList.remove('new-join-pulse'), 900);
      }
      if (num) {
        num.style.transform = 'scale(1.12)';
        num.style.transition = 'transform 420ms ease-out';
        setTimeout(()=> { num.style.transform = ''; }, 420);
      }
    }

    /* ---------------------------
       Avatar fetching (unchanged)
       --------------------------- */
    async function fetchIranAvatars(){
      try {
        const avatarMap = loadAvatarMap();
        const femaleCount = memberProfiles.filter(p => p.gender === 'female').length;
        const maleCount = memberProfiles.length - femaleCount;

        const targetFemaleFetch = Math.min(600, Math.ceil(femaleCount * 1.6) + 60);
        const targetMaleFetch = Math.min(600, Math.ceil(maleCount * 1.6) + 60);

        async function fetchPool(gender, results, nat){
          if (results <= 0) return [];
          const natParam = nat ? `&nat=${nat}` : '';
          const url = `https://randomuser.me/api/?gender=${gender}&results=${results}${natParam}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('randomuser fetch failed');
          const json = await res.json();
          const seen = new Set();
          const unique = [];
          (json.results || []).forEach(u => {
            const id = (u.login && u.login.uuid) || u.email || (u.picture && u.picture.large) || null;
            const pic = (u.picture && (u.picture.large || u.picture.medium || u.picture.thumbnail)) || null;
            if (!pic) return;
            if (id && seen.has(id)) return;
            if (pic && Array.from(seen).some(s => s === pic)) return;
            seen.add(id || pic);
            unique.push({ id, pic });
          });
          return unique;
        }

        let femalePool = [], malePool = [];
        try {
          [femalePool, malePool] = await Promise.all([
            fetchPool('female', targetFemaleFetch, 'ir'),
            fetchPool('male', targetMaleFetch, 'ir')
          ]);
        } catch (errNat) {
          console.warn('nat=ir fetch failed, falling back to general fetch', errNat);
          [femalePool, malePool] = await Promise.all([
            fetchPool('female', Math.min(200, targetFemaleFetch), ''),
            fetchPool('male', Math.min(200, targetMaleFetch), '')
          ]);
        }

        let femalePics = femalePool.map(x => x.pic);
        let malePics = malePool.map(x => x.pic);

        function shuffle(a){ for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } }
        shuffle(femalePics); shuffle(malePics);

        memberProfiles.forEach(p => { if (avatarMap[p.name]) p.avatar = avatarMap[p.name]; else p.avatar = null; });

        let fIdx = 0, mIdx = 0;
        for (let i = 0; i < memberProfiles.length; i++) {
          const p = memberProfiles[i];
          if (p.avatar) continue;
          if (p.gender === 'female' && fIdx < femalePics.length) { p.avatar = femalePics[fIdx++]; continue; }
          if (p.gender === 'male' && mIdx < malePics.length) { p.avatar = malePics[mIdx++]; continue; }
          if (fIdx < femalePics.length) { p.avatar = femalePics[fIdx++]; continue; }
          if (mIdx < malePics.length) { p.avatar = malePics[mIdx++]; continue; }
          p.avatar = null;
        }

        const remaining = memberProfiles.filter(p => !p.avatar).length;
        if (remaining > 0) {
          try {
            const pool = await fetchPool('', Math.min(800, remaining * 3 + 80), '');
            const pics = pool.map(x => x.pic);
            shuffle(pics);
            let idx = 0;
            for (let i = 0; i < memberProfiles.length && idx < pics.length; i++) {
              const p = memberProfiles[i];
              if (!p.avatar) { p.avatar = pics[idx++]; }
            }
          } catch (err) {
            console.warn('fallback pool fetch failed', err);
          }
        }

        const used = new Set();
        for (let i = 0; i < memberProfiles.length; i++) {
          const p = memberProfiles[i];
          if (p.avatar) {
            if (used.has(p.avatar)) { p.avatar = null; } else { used.add(p.avatar); }
          }
        }

        const newMap = loadAvatarMap();
        memberProfiles.forEach(p => { if (p.avatar) newMap[p.name] = p.avatar; });
        saveAvatarMap(newMap);

        renderAdminCard(); renderMembers(); renderMessages();
      } catch (err) {
        console.warn('Could not fetch iran avatars:', err);
        renderAdminCard(); renderMembers(); renderMessages();
      }
    }

    /* ---------------------------
       Lucide wiring (unchanged)
       --------------------------- */
    function wireLucideSvgs(retries = 0){
      const MAX_RETRIES = 12;
      if (window.lucide && typeof lucide.replace === 'function') {
        try { lucide.replace(); } catch(e){}
        document.querySelectorAll('svg.lucide-circle').forEach(svg => {
          svg.classList.add('online-svg');
          try {
            svg.setAttribute('stroke', '#43A047');
            svg.setAttribute('stroke-width', '2.2');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('aria-hidden', 'true');
            svg.style.display = 'inline-block';
          } catch(e){}
        });
        document.querySelectorAll('svg.lucide-pin').forEach(svg => {
          svg.classList.add('pin-svg');
          try {
            svg.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#BFBFBF');
            svg.setAttribute('stroke-width', '1.6');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('aria-hidden', 'true');
          } catch(e){}
        });
        document.querySelectorAll('svg.lucide-users').forEach(svg => {
          svg.classList.add('users-svg');
          try {
            svg.setAttribute('stroke', getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#BFBFBF');
            svg.setAttribute('stroke-width', '1.6');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('aria-hidden', 'true');
            svg.style.display = 'inline-block';
            svg.style.width = '20px';
            svg.style.height = '20px';
          } catch(e){}
        });
      } else if (retries < MAX_RETRIES) {
        setTimeout(()=> wireLucideSvgs(retries+1), 180);
      }
    }

    /* ---------------------------
       Admin detection & ordering (unchanged)
       --------------------------- */
    function detectAndMarkAdmins(){
      const rawAdmins = extractAdminNamesFromSeed();
      memberProfiles.forEach(p => {
        const found = rawAdmins.some(a => {
          if (!a) return false;
          const lowerA = a.toLowerCase();
          const lowerP = p.name.toLowerCase();
          return lowerA === lowerP || lowerA.includes(lowerP) || lowerP.includes(lowerA);
        });
        p.isAdmin = !!found;
      });
      updateHeaderMemberCount();
    }

    /* ---------------------------
       Flow simulation (non-destructive):
       - Only runs when there are NO saved messages (so it doesn't overwrite actual sessions)
       - Builds a Day 1 / Day 2 / Day 4 / Day 7 timeline closely matching your spec
       - USDT is shown once as casual mention (no explanation)
       - Adds backlog entries (older dates) visible as older-date messages
       - Adds system/day markers to make timeline readable
       --------------------------- */
    function simulateFlows(){
      // Build simulated timeline (note: times are illustrative)
      const timeline = [];

      // DAY 1 — Join Event snapshot
      timeline.push({ time: "DAY 1", member: "System", text: "Snapshot — Day 1: Join event", role: "system" });
      timeline.push({ time: "09:02", member: "Admin", text: "Welcome. Please read pinned rules before participating.", role: "admin" });
      timeline.push({ time: "09:11", member: "Moderator", text: "Verification is required before any sensitive discussion. DM admin.", role: "mod" });
      timeline.push({ time: "09:18", member: "Member (Tehran)", text: "Thanks, read the rules.", role: "member" });
      timeline.push({ time: "09:41", member: "Member (Isfahan)", text: "Bank transfers delayed again today.", role: "member" });
      timeline.push({ time: "09:44", member: "Moderator", text: "Please keep banking questions private with admin.", role: "mod" });
      // show calm chat state (system)
      timeline.push({ time: "09:50", member: "System", text: "Chat is calm — not busy", role: "system" });

      // DAY 2 — Passive observation
      timeline.push({ time: "DAY 2", member: "System", text: "Snapshot — Day 2: Passive observation & backlog", role: "system" });
      // older messages (backlog), older dates shown as dates
      timeline.push({ time: "Jan 3", member: "Member", text: "Rial lost more this week.", role: "member" });
      timeline.push({ time: "Jan 5", member: "Member", text: "Same here. Hard to keep value.", role: "member" });
      timeline.push({ time: "Jan 8", member: "Moderator", text: "Reminder: this group is for protection, not speculation.", role: "mod" });
      timeline.push({ time: "14:12", member: "Member", text: "Waiting for verification.", role: "member" });
      timeline.push({ time: "16:40", member: "Moderator", text: "Please be patient. Admin reviews in batches.", role: "mod" });
      // USDT casual mention (once, no explanation)
      timeline.push({ time: "18:05", member: "Member", text: "USDT helped me avoid last drop.", role: "member" });

      // Admin announcement about verification queue
      timeline.push({ time: "11:00", member: "Admin", text: "Verification queue is almost full today. Next review window tomorrow.", role: "admin" });

      // small confirmations
      timeline.push({ time: "10:22", member: "Member", text: "Got approved yesterday.", role: "member" });
      timeline.push({ time: "10:24", member: "Member", text: "Same here. Took a few days.", role: "member" });
      timeline.push({ time: "15:10", member: "Member", text: "Still waiting.", role: "member" });
      timeline.push({ time: "15:11", member: "Moderator", text: "Please DM admin directly.", role: "mod" });

      // Day 2 snapshot system note: smaller number visual (display-only)
      timeline.push({ time: "DAY 2 SUMMARY", member: "System", text: "Total members: ~130 — Online now: 4–7 (fluctuates). Language: Mostly Persian (formal).", role: "system" });

      // Day 2 backlog (older)
      timeline.push({ time: "3 weeks ago", member: "Member", text: "Comment about inflation.", role: "member" });
      timeline.push({ time: "2 weeks ago", member: "Moderator", text: "Rule clarification.", role: "mod" });
      timeline.push({ time: "10 days ago", member: "Member", text: "Casual local remark.", role: "member" });
      timeline.push({ time: "8 days ago", member: "Admin", text: "Procedural announcement — no action required.", role: "admin" });
      timeline.push({ time: "11:18", member: "Member", text: "Waiting / confirmation-type message.", role: "member" });
      timeline.push({ time: "12:42", member: "Moderator", text: "Patience / process reminder.", role: "mod" });
      timeline.push({ time: "15:09", member: "Member", text: "Indirect mention of USDT as protection.", role: "member" });

      // DAY 4 — light social proof
      timeline.push({ time: "DAY 4", member: "System", text: "Snapshot — Day 4: Light social proof", role: "system" });
      timeline.push({ time: "09:31", member: "Member", text: "Approved / completed step reference.", role: "member" });
      timeline.push({ time: "09:34", member: "Member", text: "Similar neutral confirmation.", role: "member" });
      timeline.push({ time: "14:06", member: "Admin", text: "Procedural notice about limited verification window.", role: "admin" });
      timeline.push({ time: "16:21", member: "New member", text: "General question — non-technical.", role: "new" });
      timeline.push({ time: "16:24", member: "Moderator", text: "Redirect to admin DM.", role: "mod" });

      // DAY 7 — reminders & casual comments
      timeline.push({ time: "DAY 7", member: "System", text: "Snapshot — Day 7: Light reminders", role: "system" });
      timeline.push({ time: "10:12", member: "Member", text: "Casual Iran-specific comment.", role: "member" });
      timeline.push({ time: "13:40", member: "Member", text: "Waiting / acknowledgment.", role: "member" });
      timeline.push({ time: "17:02", member: "Moderator", text: "Reminder about privacy", role: "mod" });

      // Insert timeline into seededMessages
      seededMessages = [];
      timeline.forEach(m => seededMessages.push(m));

      // Save to localStorage so this simulated flow remains
      saveMessages(seededMessages);

      // Visual-only: show "~130" in header for DAY 2 snapshot moment by adding a system note that will update display
      // We won't mutate memberProfiles — only adjust displayed header text when rendering messages if DAY 2 SUMMARY appears.
    }

    /* ---------------------------
       On init: if no saved messages, simulate flows; otherwise keep saved messages (non-destructive)
       --------------------------- */
    function init(){
      renderPinned();

      // Load persisted messages if present
      const savedMsgs = loadMessages();
      if (Array.isArray(savedMsgs) && savedMsgs.length > 0) {
        seededMessages = savedMsgs.slice();
      } else {
        // No saved messages: seed the simulation timeline you requested
        simulateFlows();
      }

      // Mark admins based on seededMessages (keeps original detection)
      detectAndMarkAdmins();

      // Avatar map restore
      const avatarMap = loadAvatarMap();
      if (Object.keys(avatarMap).length > 0) {
        memberProfiles.forEach(p => { if (avatarMap[p.name]) p.avatar = avatarMap[p.name]; });
      }

      // Online list restore / compute
      const savedOnline = loadOnlineList();
      if (Array.isArray(savedOnline) && savedOnline.length > 0) {
        applyOnlineList(savedOnline);
      } else {
        const initialVal = parseInt(statusNumberEl.textContent, 10) || 6;
        const list = computeDeterministicOnlineList(initialVal);
        applyOnlineList(list);
        saveOnlineList(list);
      }

      // If Day 2 SUMMARY system note exists, update visual header-member-count to ~130 (display-only)
      const day2Summary = seededMessages.find(m => m.time === 'DAY 2 SUMMARY' && m.role === 'system');
      if (day2Summary) {
        // store original displayed text so we can still use logic with memberProfiles available
        const headerEl = document.getElementById('header-member-count');
        if (headerEl) {
          // visual change: show ~130 in the header (keeps memberProfiles unchanged)
          headerEl.textContent = '~130';
          // after a short delay (simulate snapshot), restore to real count (keeps logic intact)
          setTimeout(() => { updateHeaderMemberCount(); }, 8000);
        }
      } else {
        updateHeaderMemberCount();
      }

      renderAdminCard(); renderMembers(); renderMessages();
      wireLucideSvgs();

      window.addEventListener('load', () => { setTimeout(()=> wireLucideSvgs(0), 120); });

      // Aggressive avatar assignment attempt (best-effort)
      fetchIranAvatars();

      // periodic subtle status updates (display only)
      setInterval(updateStatusNumber, 5000 + Math.floor(Math.random()*7000));
    }

    init();
  </script>

  <script>
    // ensure lucide icons are created ASAP for the header/stats/icons
    (function ensureLucide(){
      if (window.lucide && typeof lucide.replace === 'function') {
        try { lucide.replace(); } catch(e){ /* ignore */ }
      } else {
        // try again shortly
        setTimeout(ensureLucide, 160);
      }
    })();
  </script>
</body>
</html>
