<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Group: Private Digital Asset Discussion (Iran)</title>

  <!-- Tailwind for layout only -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest/dist/lucide.min.js"></script>

  <style>
    /* -------------------------
       Theme: Quiet Institutional Dark Mode
       ------------------------- */
    :root{
      --bg: #232323;         /* primary dark gray */
      --panel: #262626;      /* panel slightly lighter */
      --text: #DADADA;       /* off-white for body text */
      --muted: #BFBFBF;      /* secondary text */
      --divider: #333333;    /* subtle dividers */
      --accent: #43A047;     /* muted green accent */
      --accent-dark: #3d923f;
    }
    html,body,#app{height:100%}
    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* containers */
    .panel {
      background: var(--panel);
      border: 1px solid var(--divider);
      border-radius: 12px;
    }

    .avatar-fallback {
      background: linear-gradient(135deg,#2e2e2e,#383838);
      display:flex; align-items:center; justify-content:center;
      color:var(--text); font-weight:600; text-transform:uppercase;
    }

    /* STATUS */
    .status-icon-wrap { display:inline-flex; align-items:center; gap:8px; }
    @keyframes blinkPulse {
      0% { opacity: 1; transform: scale(1); filter: drop-shadow(0 0 0 rgba(0,0,0,0)); }
      50% { opacity: 0.45; transform: scale(1.08); filter: drop-shadow(0 0 8px rgba(67,160,71,0.12)); }
      100% { opacity: 1; transform: scale(1); filter: drop-shadow(0 0 0 rgba(0,0,0,0)); }
    }
    /* faster/louder pulse when new join arrives */
    @keyframes joinPulse {
      0% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(67,160,71,0)); opacity:1; }
      40% { transform: scale(1.18); filter: drop-shadow(0 0 14px rgba(67,160,71,0.18)); opacity:1; }
      100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(67,160,71,0)); opacity:1; }
    }

    .online-svg {
      width: 14px; height: 14px; display:inline-block; vertical-align:middle;
      color: var(--accent); /* stroke uses currentColor */
      animation: blinkPulse 1.6s infinite ease-in-out;
      transform-origin: 50% 50%;
    }

    /* when we highlight a new join */
    .new-join-pulse {
      animation: joinPulse 900ms ease-in-out;
    }

    /* numeric subtle pulse */
    @keyframes numberPulse {
      0% { transform: translateY(0); opacity: 1; }
      50% { transform: translateY(-1px) scale(1.02); opacity: 0.98; }
      100% { transform: translateY(0); opacity: 1; }
    }
    .status-number { animation: numberPulse 2200ms infinite ease-in-out; color: var(--accent-dark); font-weight:700; }

    /* pinned icon styling (we add .pin-svg to lucide pin) */
    .pin-svg {
      width: 16px; height: 16px; vertical-align: -2px; margin-right: 6px;
      color: #BFBFBF; /* subtle */
      display:inline-block;
    }

    /* messages */
    .msg-admin { background: linear-gradient(180deg,#2b2b2b,#272727); border-left:4px solid rgba(74,144,226,0.12); padding:12px; border-radius:10px; }
    .msg-mod { background: linear-gradient(180deg,#262626,#232323); border-left:4px solid rgba(120,120,120,0.08); padding:12px; border-radius:10px; }
    .msg-system { font-style: italic; color: #9CA3AF; padding: 8px; }
    .msg-regular { background: linear-gradient(180deg,#262626,#242424); padding:12px; border-radius:10px; }

    /* highlight when new member joins */
    @keyframes newJoinHighlight {
      0% { box-shadow: 0 0 0 rgba(67,160,71,0); transform: scale(1); background-color: rgba(255,255,255,0); }
      10% { background-color: rgba(67,160,71,0.06); transform: scale(1.015); }
      60% { box-shadow: 0 8px 28px rgba(67,160,71,0.12); transform: scale(1.02); }
      100% { box-shadow: 0 0 0 rgba(67,160,71,0); transform: scale(1); background-color: transparent; }
    }
    .highlight-new {
      animation: newJoinHighlight 3200ms ease-in-out forwards;
      border-radius: 10px;
    }

    img.round-avatar { width:40px; height:40px; border-radius:9999px; object-fit:cover; flex-shrink:0; }

    /* subtle divider */
    .divider { border-top: 1px solid #333333; margin: 12px 0; }

    /* responsiveness */
    @media (max-width:640px){
      .online-svg{ width:12px; height:12px; }
      .pin-svg{ width:14px; height:14px; margin-right:4px; }
    }
  </style>
</head>
<body>
  <div id="app" class="min-h-screen p-4 md:p-8">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h1 id="group-title" class="text-xl md:text-2xl font-semibold" style="color:var(--text)">Group: Private Digital Asset Discussion (Iran)</h1>
        <div class="text-sm" style="color:var(--muted); margin-top:6px;">
          <strong id="member-approx">Members (visible): ~140</strong> — <span id="date-range">Period: 8 January 2026 — 15 January 2026</span>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <div class="text-right">
          <div class="text-sm font-medium" style="color:var(--muted)">Status</div>
          <div class="status-icon-wrap" role="status" aria-live="polite" aria-atomic="true">
            <i data-lucide="circle" aria-hidden="true"></i>
            <div id="status-text" class="text-sm" style="color:var(--text)">Active now: <span id="status-number" class="status-number">6</span></div>
          </div>
        </div>
      </div>
    </header>

    <main class="flex flex-1 flex-col md:flex-row gap-4">
      <section class="flex-1 flex flex-col panel overflow-hidden">
        <div class="p-4 border-b" style="border-color:var(--divider); display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="text-sm font-medium" style="color:var(--text)">PINNED CONTENT (always visible)</div>
            <ul id="pinned-list" class="mt-2 text-sm" style="color:var(--muted); list-style:none; padding-left:0; gap:6px;"></ul>
          </div>
          <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
            <button id="copy-pinned" class="px-3 py-1 rounded-full border" style="background:transparent; border-color:var(--divider); color:var(--text); font-size:12px;">Copy</button>
            <button id="toggle-notes" class="px-3 py-1 rounded-full border" style="background:transparent; border-color:var(--divider); color:var(--text); font-size:12px;" aria-expanded="false">Notes</button>
          </div>
        </div>

        <div id="chat-window" class="p-4 flex-1 overflow-auto" role="log" aria-live="polite">
          <div id="messages-list" class="space-y-3"></div>
        </div>

        <div class="p-4 border-t" style="border-color:var(--divider); background:transparent;">
          <div id="composer-locked" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
            <div style="color:var(--muted)">Posting is locked until verification. Please request verification to post.</div>
            <div>
              <button id="verify-btn" class="px-3 py-1 rounded bg-[var(--accent)]" style="background:var(--accent); color:#fff;">Request verification</button>
            </div>
          </div>

          <div id="composer" class="hidden" style="display:flex; gap:12px; margin-top:8px; align-items:flex-start;">
            <textarea id="composer-text" placeholder="Type a message — Enter to send" class="flex-1" style="padding:12px; border-radius:10px; border:1px solid var(--divider); background:#262626; color:var(--text); min-height:64px;"></textarea>
            <div>
              <button id="send-btn" style="padding:8px 12px; border-radius:8px; background:#2E7D32; color:#fff;">Send</button>
            </div>
          </div>
        </div>
      </section>

      <aside class="w-full md:w-72 flex-shrink-0 panel p-4">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
          <h2 style="font-weight:600; color:var(--text); font-size:14px;">MEMBERS (names)</h2>
          <span style="color:var(--muted); font-size:12px;">Realistic view</span>
        </div>
        <div id="members-list" style="display:flex; flex-direction:column; gap:10px; color:var(--muted);"></div>
      </aside>
    </main>

    <div id="behavior-notes" class="panel" style="display:none; margin-top:16px; padding:12px; color:var(--muted);">
      <h3 style="color:var(--text); font-weight:600;">REALISTIC CHAT PARTICIPATION (pattern & stats)</h3>
      <pre style="white-space:pre-wrap; color:var(--muted)">(Overview & instructor notes stored in the script)</pre>
    </div>

    <footer style="margin-top:12px; color:var(--muted); font-size:12px;">To host on GitHub Pages, save this file as <code>index.html</code> in your repo root (or /docs). Demo content is fictional.</footer>
  </div>

  <script>
    /************************************************************************
     * Full logic preserved:
     * - pinned array
     * - members array (140)
     * - seededMessages array (Day1..Day7 + backlog)
     * - avatar heuristics with randomuser.me?nat=ir fetch
     * - lucide wiring & stroke coloring
     * - verification composer gating
     * - new-member stronger animation (message highlight + status pulse)
     ************************************************************************/

    /* ---------------------------
       Pinned content
       --------------------------- */
    const pinned = [
      "Privacy rules (Iran-focused)",
      "Verification required to participate in sensitive discussions",
      "Group purpose: protect asset value, not investment advice",
      "No screenshots or forwarding",
      "Sensitive questions → DM the admin"
    ];

    /* ---------------------------
       Members (140) - same as your list
       --------------------------- */
    const members = [
      "Ariamen Niknam","Zhinos Farmani","Misaq Dashti","Pardis Sohrabi","Pouyan Tarabnia","Zhaleh Pourbakhtiar","Derina Kermani","Sohrab Mehrayin","Sepand Yaghmaei","Bakhtiar Kohandel",
      "Taraneh Rozbehani","Saman Tihu","Padideh Naderi","Niko Foroughi","Hamoon Zagros","Naysabeh Tahmasbi","Diana Siavoshi","Bahman Azarpi","Negin Koneshlu","Rosta Mehrayin",
      "Saman-yar Ahoui","Yara Zhilavand","Parsa Shayeg","Mahraz Golestani","Siamak Hoorami","Helia Mahinpour","Nima Taban","Parvosh Ramyar","Hooshang Bahari","Naghmeh Soroush",
      "Kourosh Nikmanesh","Kian Rudbar","Narges Delaram","Sudeh Kianpour","Amin Shayegan","Niloufar Behrbakhsh","Soha Armaghani","Dara Firoozi","Zhila Mehraban","Samyar Rudgar",
      "Mahrokh Khodadadi","Nava Sayad","Parmida Sahli","Parham Soleimani-Nejad","Sepideh Nikandish","Pegah Derakhshan","Toranj Keyvani","Shahin Pejmanfar","Sheyda Alavi","Hoshmand Kateb",
      "Mojgan Forouhar","Ahura Bahrami","Azadeh Nistani","Farshid Yousefi","Yeganeh Semnani","Siros Padidar","Ainaz Goodarzi","Mani Arashid","Roonak Ghaffari","Radin Sepehri",
      "Mahshad Barghaei","Keyvan Rostami","Nazanin Dehghani","Homa Nadali","Nira Eghbali","Pouyan Kohanzad","Matiah Khoramdel","Baran Jamshidi","Kiarash Mardani","Zaria Farhang",
      "Dihim Nazari","Behnam Alghasi","Golareh Malkani","Koroshian Tarkan","Raha Beheshti","Soheil Nikkhah","Zhaki Zhalehpoor","Rambod Hejri","Shaparak Fallahi","Kamyar Homayounfar",
      "Tarlan Daryabigi","Kimia Khojasteh","Pouya Nasrollahi","Mahyar Farahani","Ladan Soleimani","Niusha Mehraban","Sina Khaleghi","Golsa Shayegan","Abtin Kamali","Farnaz Bahrampour",
      "Mehrangiz Rabiei","Arshan Mahdavi","Yasaman Azarban","Shervin Ganji","Tarnam Mahasti","Arshin Boroumand","Nikzad Shahidi","Bahareh Sirafi","Kikavous Niknami","Mehrnoush Azargun",
      "Parsa Delshad","Zhubin Razaqi","Tahmineh Nikkhah","Houtan Delpak","Roya Danaei","Niloufar Shahryar","Zhyar Kamyab","Mina Salimi","Shayan Mazinani","Diana Farahmand",
      "Arian Mehranfar","Yekta Feyzi","Naderah Pasandideh","Kianoush Damghani","Azadeh Mehrgostar","Samdel Shahrokhi","Mahtab Forouzh","Shayan Nikpour","Koraogh Lilizad","Hamasin Kouhi",
      "Pouyan Zanganeh","Ramin Yarmohammadi","Niloufar Arshidi","Gerard Golchin","Hooman Panjabi","Rana Keyvani","Shahrooz Mehrabi","Minoudokht Bahrami","Adrian Feyzabad","Zarrin Golmohammadi",
      "Farshad Kamkar","Pegah Naderian","Arzu Farozand","Delara Niri","Niko Golrokh","Sepehr Nikrosh","Samaneh Arvand","Yousef Rouzbeh","Mahtab Nobahar","Pedram Shakiba"
    ];

    /* ---------------------------
       Seeded messages (Day1..Day7 + backlog)
       (copied exactly from your provided transcript)
       --------------------------- */
    const seededMessages = [
      { time: "08:57", member: "System", text: "You joined the group.", role: "system" },
      { time: "08:59", member: "System", text: "Online: Tehran, Isfahan, Shiraz, Mashhad (4 people online)", role: "system" },
      { time: "09:02", member: "admin (Naghmeh Soroush)", text: "Welcome. Please read the pinned rules.", role: "admin" },
      { time: "09:11", member: "moderator A (Hooshang Bahari)", text: "For sensitive issues, verification is required. DM the admin.", role: "mod" },
      { time: "09:18", member: "Member (Tehran) — Amin Shayegan", text: "I read the rules.", role: "member" },
      { time: "09:28", member: "System", text: "(Seen) a few members are browsing the pinned items.", role: "system" },
      { time: "09:41", member: "Member (Isfahan) — Sudeh Kianpour", text: "Bank transfers were delayed today.", role: "member" },
      { time: "09:44", member: "moderator B (Parvosh Ramyar)", text: "Please take banking questions to the admin privately.", role: "mod" },
      { time: "10:01", member: "Member (Tehran) — Amin Shayegan", text: "Understood.", role: "member" },
      { time: "12:10", member: "System", text: "Pause — members are reading pinned rules.", role: "system" },
      { time: "15:08", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "Morning traffic in Tehran was bad.", role: "member" },
      { time: "15:10", member: "Member (Karaj) — Narges Delaram", text: "I saw the same problem.", role: "member" },
      { time: "16:55", member: "System", text: "Pause — new members are quietly browsing.", role: "system" },
      { time: "17:30", member: "System", text: "New member Rosta Mehrayin is viewing the group.", role: "system" },
      { time: "19:12", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "It seems the rial is weaker today.", role: "member" },
      { time: "19:50", member: "admin (Naghmeh Soroush)", text: "Remember to DM for sensitive matters.", role: "admin" },
      { time: "20:05", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "Just my experience — USDT helped me last week.", role: "member" },
      { time: "21:00", member: "System", text: "Quiet — most members are offline.", role: "system" },

      { time: "08:50", member: "Member (Tehran) — Amin Shayegan", text: "I joined yesterday. Still not verified.", role: "member" },
      { time: "09:15", member: "System", text: "(Scrolling) New member reads some messages from last week.", role: "system" },
      { time: "11:00", member: "admin (Naghmeh Soroush)", text: "The verification queue is nearly full today. Next review window is tomorrow.", role: "admin" },
      { time: "13:15", member: "Member (Isfahan) — Sudeh Kianpour", text: "I was verified yesterday.", role: "member" },
      { time: "13:16", member: "moderator A (Hooshang Bahari)", text: "Welcome — please DM for questions.", role: "mod" },
      { time: "14:12", member: "Member (Karaj) — Kian Rudbar", text: "I’m waiting for verification.", role: "member" },
      { time: "15:00", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "A few who got verified said USDT helped.", role: "member" },
      { time: "16:40", member: "moderator B (Parvosh Ramyar)", text: "Please be patient. Admin reviews in batches.", role: "mod" },
      { time: "18:05", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "USDT helped me avoid the previous drop.", role: "member" },
      { time: "18:12", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "Me too. Holding some USDT helped.", role: "member" },
      { time: "19:30", member: "System", text: "Relative silence — members mostly reading.", role: "system" },
      { time: "21:12", member: "Member (Karaj) — Kian Rudbar", text: "Still waiting.", role: "member" },

      { time: "18 Dec", member: "Member", text: "Inflation is high. Saving is hard.", role: "member" },
      { time: "25 Dec", member: "moderator A", text: "Reminder — sensitive questions → DM admin.", role: "mod" },
      { time: "30 Dec", member: "Member", text: "Tehran traffic was heavy this week.", role: "member" },
      { time: "01 Jan", member: "admin", text: "Verification process updated. No action required now.", role: "admin" },

      { time: "09:31", member: "Member (Karaj) — Narges Delaram", text: "I got verified. Verification step complete.", role: "member" },
      { time: "09:34", member: "Member (Tehran) — Amin Shayegan", text: "Me too.", role: "member" },
      { time: "10:00", member: "Member (Isfahan) — Sudeh Kianpour", text: "Happy for you.", role: "member" },
      { time: "14:06", member: "admin (Naghmeh Soroush)", text: "Verification window is limited today. Please wait your turn.", role: "admin" },
      { time: "16:21", member: "New member (Isfahan) — Rosta Mehrayin", text: "Any tips to start?", role: "new" },
      { time: "16:24", member: "moderator A (Hooshang Bahari)", text: "Please DM admin for details.", role: "mod" },
      { time: "18:02", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "Bank delays continue.", role: "member" },

      { time: "08:45", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "Commute was easier today.", role: "member" },
      { time: "09:00", member: "Member (Tehran) — Amin Shayegan", text: "Glad.", role: "member" },
      { time: "10:15", member: "Member (Tehran) — Amin Shayegan", text: "Still waiting for verification.", role: "member" },
      { time: "13:30", member: "moderator B (Parvosh Ramyar)", text: "Reminder: no screenshots or forwarding.", role: "mod" },
      { time: "15:00", member: "Member (Karaj) — Narges Delaram", text: "The verification took a while but arrived.", role: "member" },
      { time: "17:05", member: "Member (Karaj) — Narges Delaram", text: "Rial was slightly more stable today.", role: "member" },

      { time: "09:10", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "I was verified yesterday.", role: "member" },
      { time: "12:55", member: "Member (Tehran) — Amin Shayegan", text: "Morning traffic and rial volatility — nothing new.", role: "member" },
      { time: "15:02", member: "moderator A (Hooshang Bahari)", text: "Sensitive questions → DM admin.", role: "mod" },
      { time: "16:32", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "Just FYI, I had some USDT.", role: "member" },
      { time: "16:35", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "My experience was similar, just saying.", role: "member" },

      { time: "08:32", member: "Member (Karaj) — Kian Rudbar", text: "Have you seen the bank notice today?", role: "member" },
      { time: "09:10", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "I was verified yesterday.", role: "member" },
      { time: "12:55", member: "Member (Tehran) — Amin Shayegan", text: "No change; delays continue.", role: "member" },
      { time: "14:55", member: "moderator B (Parvosh Ramyar)", text: "Verification is processed in batches; please be patient.", role: "mod" },
      { time: "15:10", member: "New member — Rosta Mehrayin", text: "Thanks. I will wait.", role: "new" },
      { time: "17:10", member: "Member (Tehran) — Amin Shayegan", text: "Personal view: USDT still looks safer.", role: "member" },

      { time: "08:50", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "It’s warmer here this morning.", role: "member" },
      { time: "09:20", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "Still waiting for admin verification.", role: "member" },
      { time: "10:00", member: "Member (Isfahan) — Sudeh Kianpour", text: "I was verified; everything is normal.", role: "member" },
      { time: "13:40", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "No news. Testing my patience.", role: "member" },
      { time: "14:00", member: "moderator A (Hooshang Bahari)", text: "Please do not post personal contact info publicly.", role: "mod" },
      { time: "15:29", member: "Member (Isfahan) — Sudeh Kianpour", text: "I got verified a few days ago. Nothing special.", role: "member" },
      { time: "17:05", member: "Member (Karaj) — Narges Delaram", text: "Personal experience: USDT helped preserve value.", role: "member" },
      { time: "19:10", member: "System", text: "admin offline — no public post.", role: "system" },

      { time: "09:05", member: "System", text: "3–6 people were online in the morning.", role: "system" },
      { time: "10:12", member: "Member (Shiraz) — Niloufar Behrbakhsh", text: "Tehran is warmer than last week.", role: "member" },
      { time: "11:00", member: "admin (Naghmeh Soroush)", text: "Verification queue updated; if you applied in the past 72 hours, check your DM.", role: "admin" },
      { time: "13:40", member: "Member (Mashhad) — Kourosh Nikmanesh", text: "Still waiting. My patience is being tested.", role: "member" },
      { time: "14:30", member: "moderator B (Parvosh Ramyar)", text: "Reminder: privacy is important. No screenshots or forwarding.", role: "mod" },
      { time: "17:02", member: "moderator A (Hooshang Bahari)", text: "Please DM sensitive banking questions.", role: "mod" },
      { time: "18:30", member: "Member (Karaj) — Narges Delaram", text: "A few people got verified, no big news. Calm.", role: "member" },
      { time: "20:05", member: "Member (Karaj) — Narges Delaram", text: "My USDT mention is personal experience. Not advice.", role: "member" }
    ];

    /* ---------------------------
       Avatar heuristics
       --------------------------- */
    const femaleTokens = [
      "zhaleh","derina","taraneh","padideh","niko","naysabeh","diana","negin","yara","narges",
      "sudeh","niloufar","pegah","shaparak","mina","roonak","zaria","mojgan","azadeh","yasaman",
      "delara","bahareh","mehrnoush","zarrin","mahtab","niusha","golsa","yekta","nazanin","homa",
      "farah","parida","parisa","soheila","zahra","fatemeh","marjan","sara","roxana","rosta"
    ];
    function looksFemale(name){ if(!name) return false; const lower=name.toLowerCase(); return femaleTokens.some(t=>lower.includes(t)); }
    function randInt(max){ return Math.floor(Math.random()*max); }

    // initial profiles with null avatars; we'll fetch nat=ir portraits next
    const memberProfiles = members.map(name => ({ name, avatar: null, gender: looksFemale(name) ? 'female' : 'male' }));

    /* ---------------------------
       DOM refs
       --------------------------- */
    const pinnedList = document.getElementById('pinned-list');
    const membersListEl = document.getElementById('members-list');
    const messagesList = document.getElementById('messages-list');
    const chatWindow = document.getElementById('chat-window');
    const statusNumberEl = document.getElementById('status-number');

    /* ---------------------------
       Render functions
       --------------------------- */
    function renderPinned(){
      pinnedList.innerHTML = '';
      pinned.forEach(p => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.alignItems = 'center';
        li.style.gap = '8px';
        li.style.marginBottom = '6px';
        // placeholder icon
        const icon = document.createElement('i');
        icon.setAttribute('data-lucide','pin');
        icon.setAttribute('aria-hidden','true');
        li.appendChild(icon);
        const span = document.createElement('span');
        span.textContent = p;
        span.style.color = 'var(--muted)';
        li.appendChild(span);
        pinnedList.appendChild(li);
      });
      // lucide will be wired later
    }

    function createFallbackElement(name){
      const fallback = document.createElement('div');
      fallback.className = 'avatar-fallback';
      fallback.style.width = '40px';
      fallback.style.height = '40px';
      fallback.style.borderRadius = '9999px';
      fallback.style.fontSize = '12px';
      fallback.style.flexShrink = '0';
      const initials = (name || '').split(' ').map(s => s[0]).slice(0,2).join('') || 'M';
      fallback.textContent = initials;
      return fallback;
    }

    function renderMembers(){
      membersListEl.innerHTML = '';
      memberProfiles.forEach(m => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.gap = '10px';
        const left = document.createElement('div');
        if(m.avatar){
          const img = document.createElement('img');
          img.src = m.avatar;
          img.alt = m.name;
          img.className = 'round-avatar';
          img.style.width = '40px';
          img.style.height = '40px';
          img.style.borderRadius = '9999px';
          img.style.objectFit = 'cover';
          img.style.flexShrink = '0';
          img.onerror = () => { img.remove(); left.appendChild(createFallbackElement(m.name)); };
          left.appendChild(img);
        } else {
          left.appendChild(createFallbackElement(m.name));
        }
        row.appendChild(left);
        const nameDiv = document.createElement('div');
        nameDiv.style.color = 'var(--muted)';
        nameDiv.style.fontSize = '14px';
        nameDiv.textContent = m.name;
        row.appendChild(nameDiv);
        membersListEl.appendChild(row);
      });
    }

    function renderMessages(){
      messagesList.innerHTML = '';
      seededMessages.forEach((m, idx) => {
        const article = document.createElement('article');
        article.style.marginBottom = '8px';
        if(m.role === 'system'){
          article.className = 'msg-system';
          article.textContent = `${m.time} ${m.text}`;
        } else {
          article.className = m.role === 'admin' ? 'msg-admin' : m.role === 'mod' ? 'msg-mod' : 'msg-regular';
          article.style.padding = '12px';
          article.style.borderRadius = '10px';
          const header = document.createElement('div');
          header.style.display = 'flex';
          header.style.justifyContent = 'space-between';
          header.style.alignItems = 'center';

          const left = document.createElement('div');
          left.style.display = 'flex';
          left.style.alignItems = 'center';
          left.style.gap = '10px';

          const profile = memberProfiles.find(p => m.member && p.name && m.member.includes(p.name));
          if(profile && profile.avatar){
            const img = document.createElement('img');
            img.src = profile.avatar;
            img.alt = profile.name;
            img.className = 'round-avatar';
            img.style.width = '40px';
            img.style.height = '40px';
            img.style.borderRadius = '9999px';
            img.style.objectFit = 'cover';
            img.onerror = () => { img.remove(); left.insertBefore(createFallbackElement(profile.name), left.firstChild || null); };
            left.appendChild(img);
          } else {
            left.appendChild(createFallbackElement(m.member));
          }

          const nameDiv = document.createElement('div');
          nameDiv.style.fontWeight = '600';
          nameDiv.style.color = 'var(--text)';
          nameDiv.textContent = m.member || 'Member';
          left.appendChild(nameDiv);

          header.appendChild(left);

          const time = document.createElement('div');
          time.style.color = 'var(--muted)';
          time.style.fontSize = '12px';
          time.textContent = m.time;
          header.appendChild(time);

          const p = document.createElement('p');
          p.style.marginTop = '8px';
          p.style.color = 'var(--text)';
          p.style.fontSize = '14px';
          p.textContent = m.text;

          article.appendChild(header);
          article.appendChild(p);

          // If this is a "new member" event, add highlight and trigger status pulse
          const isNewMember = (m.role === 'new') || (m.role === 'system' && m.text && m.text.toLowerCase().includes('new member'));
          if (isNewMember) {
            // apply highlight; remove after animation duration
            article.classList.add('highlight-new');
            // also apply a stronger pulse to status icon/number
            triggerStatusJoinPulse();
            // remove highlight after 3.2s
            setTimeout(() => { article.classList.remove('highlight-new'); }, 3200);
          }
        }
        messagesList.appendChild(article);
      });
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    /* ---------------------------
       Copy pinned, toggle notes, composer logic (unchanged)
       --------------------------- */
    document.getElementById('copy-pinned').addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(pinned.join('\n')); alert('Pinned rules copied to clipboard'); }
      catch (err) { console.warn('copy failed', err); alert('Unable to copy'); }
    });

    document.getElementById('toggle-notes').addEventListener('click', () => {
      const el = document.getElementById('behavior-notes');
      const isHidden = el.style.display === 'none' || el.style.display === '';
      el.style.display = isHidden ? 'block' : 'none';
      document.getElementById('toggle-notes').setAttribute('aria-expanded', String(isHidden));
    });

    document.getElementById('verify-btn').addEventListener('click', () => {
      document.getElementById('composer-locked').style.display = 'none';
      document.getElementById('composer').style.display = 'flex';
      document.getElementById('composer-text').focus();
    });

    document.getElementById('send-btn').addEventListener('click', () => {
      const txt = document.getElementById('composer-text').value.trim();
      if (!txt) return;
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      seededMessages.push({ time: timeStr, member: 'You', text: txt, role: 'member' });
      document.getElementById('composer-text').value = '';
      renderMessages();
    });

    document.getElementById('composer-text').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); }
    });

    /* ---------------------------
       Status number fluctuation & join pulse
       --------------------------- */
    function updateStatusNumber(){
      const val = 3 + Math.floor(Math.random() * 6); // 3..8
      statusNumberEl.textContent = val;
    }

    function triggerStatusJoinPulse(){
      // find the lucide circle svg (we add .online-svg on wire)
      const svg = document.querySelector('svg.online-svg');
      const num = document.getElementById('status-number');
      if (svg) {
        svg.classList.add('new-join-pulse');
        setTimeout(()=> svg.classList.remove('new-join-pulse'), 900);
      }
      if (num) {
        num.style.transform = 'scale(1.12)';
        num.style.transition = 'transform 420ms ease-out';
        setTimeout(()=> { num.style.transform = ''; }, 420);
      }
    }

    /* ---------------------------
       Fetch Iranian portraits (randomuser.me?nat=ir)
       Assign to ~60% of members randomly; fallbacks remain
       --------------------------- */
    async function fetchIranAvatars(count = 80){
      try {
        const res = await fetch(`https://randomuser.me/api/?nat=ir&results=${count}`);
        if (!res.ok) throw new Error('randomuser fetch failed');
        const json = await res.json();
        const portraits = (json.results || []).map(u => (u.picture && u.picture.large) ? u.picture.large : null).filter(Boolean);
        // Shuffle portraits for distribution
        for (let i = portraits.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [portraits[i], portraits[j]] = [portraits[j], portraits[i]];
        }
        let pIdx = 0;
        for (let i = 0; i < memberProfiles.length; i++) {
          if (Math.random() < 0.6 && pIdx < portraits.length) {
            memberProfiles[i].avatar = portraits[pIdx++];
          } else {
            memberProfiles[i].avatar = null;
          }
        }
        // rerender members & messages (so matched names show avatars)
        renderMembers();
        renderMessages();
      } catch (err) {
        console.warn('Could not fetch iran avatars:', err);
        renderMembers();
        renderMessages();
      }
    }

    /* ---------------------------
       Lucide wiring - replace & style svgs
       --------------------------- */
    function wireLucideSvgs(){
      if (window.lucide && typeof lucide.replace === 'function') {
        lucide.replace();
        // add classes and set stroke attributes for visibility on dark background
        document.querySelectorAll('svg.lucide-circle').forEach(svg => {
          svg.classList.add('online-svg');
          try {
            svg.setAttribute('stroke', '#43A047');
            svg.setAttribute('stroke-width', '2.2');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('aria-hidden', 'true');
            svg.style.display = 'inline-block';
          } catch(e){}
        });
        document.querySelectorAll('svg.lucide-pin').forEach(svg => {
          svg.classList.add('pin-svg');
          try {
            svg.setAttribute('stroke', '#BFBFBF');
            svg.setAttribute('stroke-width', '1.6');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('aria-hidden', 'true');
          } catch(e){}
        });
      } else {
        // retry if lucide not loaded yet
        setTimeout(wireLucideSvgs, 250);
      }
    }

    /* ---------------------------
       Init
       --------------------------- */
    function init(){
      renderPinned();
      renderMembers(); // initials may show until avatars fetched
      renderMessages();
      updateStatusNumber();
      wireLucideSvgs();
      fetchIranAvatars(80);
      // periodic subtle status updates
      setInterval(updateStatusNumber, 5000 + Math.floor(Math.random()*7000));
    }

    init();
  </script>
</body>
</html>
